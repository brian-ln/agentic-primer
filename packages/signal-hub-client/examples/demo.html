<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Signal Hub - End-to-End Demo</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .app {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .card h2 {
      font-size: 18px;
      color: #333;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .status-bar {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 13px;
    }

    .status-label {
      font-weight: 600;
      color: #666;
    }

    .status-value {
      color: #333;
      font-family: 'Monaco', 'Courier New', monospace;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
    }

    .badge.disconnected {
      background: #fee;
      color: #c33;
    }

    .badge.connecting {
      background: #ffd;
      color: #880;
    }

    .badge.connected {
      background: #d4edda;
      color: #155724;
    }

    .badge.reconnecting {
      background: #fff3cd;
      color: #856404;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #555;
      font-size: 13px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      font-family: 'Monaco', 'Courier New', monospace;
      resize: vertical;
      min-height: 80px;
    }

    .form-group small {
      display: block;
      margin-top: 4px;
      color: #777;
      font-size: 12px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      min-width: 120px;
    }

    button.primary {
      background: #667eea;
      color: white;
    }

    button.primary:hover:not(:disabled) {
      background: #5568d3;
    }

    button.secondary {
      background: #6c757d;
      color: white;
    }

    button.secondary:hover:not(:disabled) {
      background: #5a6268;
    }

    button.success {
      background: #28a745;
      color: white;
    }

    button.success:hover:not(:disabled) {
      background: #218838;
    }

    button.danger {
      background: #dc3545;
      color: white;
    }

    button.danger:hover:not(:disabled) {
      background: #c82333;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .actor-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 40px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 16px;
    }

    .actor-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: white;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      font-size: 12px;
      font-family: 'Monaco', 'Courier New', monospace;
    }

    .actor-item .remove {
      cursor: pointer;
      color: #dc3545;
      font-weight: bold;
      padding: 0 4px;
    }

    .actor-item .remove:hover {
      color: #c82333;
    }

    .log-container {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 16px;
      height: 400px;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
    }

    .log-entry {
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .log-entry .timestamp {
      color: #888;
    }

    .log-entry.info .message {
      color: #61dafb;
    }

    .log-entry.success .message {
      color: #98c379;
    }

    .log-entry.error .message {
      color: #e06c75;
    }

    .log-entry.warning .message {
      color: #e5c07b;
    }

    .subscription-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .subscription-item .topic {
      font-weight: 600;
      color: #667eea;
    }

    .subscription-item .id {
      font-family: 'Monaco', 'Courier New', monospace;
      color: #666;
      font-size: 11px;
    }

    .discovered-actors {
      max-height: 200px;
      overflow-y: auto;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .discovered-actor {
      padding: 8px;
      background: white;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .discovered-actor .address {
      font-weight: 600;
      color: #333;
      font-family: 'Monaco', 'Courier New', monospace;
    }

    .discovered-actor .caps {
      color: #666;
      margin-top: 4px;
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: #999;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <h1>Signal Hub - End-to-End Demo</h1>
      <p>Complete demonstration of broadcast, pub/sub, and discovery features</p>
    </div>

    <!-- Connection Section -->
    <div class="grid">
      <div class="card">
        <h2>Connection</h2>
        <div class="form-group">
          <label for="hubUrl">Signal Hub URL</label>
          <input type="text" id="hubUrl" value="ws://localhost:8787" placeholder="ws://localhost:8787">
        </div>
        <div class="form-group">
          <label for="hubJwt">JWT Token</label>
          <input type="text" id="hubJwt" value="dev-token" placeholder="dev-token">
          <small>Use "dev-token" for local development</small>
        </div>
        <div class="btn-group">
          <button id="connectBtn" class="primary">Connect</button>
          <button id="disconnectBtn" class="danger" disabled>Disconnect</button>
        </div>
      </div>

      <div class="card">
        <h2>Connection Status</h2>
        <div class="status-bar">
          <span class="status-label">State:</span>
          <span class="status-value"><span id="connectionState" class="badge disconnected">disconnected</span></span>

          <span class="status-label">Session ID:</span>
          <span class="status-value" id="sessionId">-</span>

          <span class="status-label">Server Version:</span>
          <span class="status-value" id="serverVersion">-</span>

          <span class="status-label">Actor Identity:</span>
          <span class="status-value" id="actorIdentity">-</span>
        </div>
      </div>
    </div>

    <!-- Actor Management -->
    <div class="grid">
      <div class="card">
        <h2>Register Actor</h2>
        <div class="form-group">
          <label for="actorAddress">Actor Address</label>
          <input type="text" id="actorAddress" placeholder="Leave empty to auto-generate">
          <small>Format: @(browser/my-widget) or auto-generate</small>
        </div>
        <div class="form-group">
          <label for="capabilities">Capabilities</label>
          <input type="text" id="capabilities" value="render, interact, update" placeholder="render, interact">
          <small>Comma-separated list</small>
        </div>
        <button id="registerActorBtn" class="success" disabled>Register Actor</button>

        <h2 style="margin-top: 24px;">Registered Actors</h2>
        <div class="actor-list" id="actorList">
          <div class="empty-state">No actors registered</div>
        </div>
      </div>

      <div class="card">
        <h2>Discovery</h2>
        <div class="form-group">
          <label for="discoverPattern">Pattern</label>
          <input type="text" id="discoverPattern" value="*" placeholder="@(browser/*)">
          <small>Use * for wildcards, e.g., @(browser/*)</small>
        </div>
        <div class="form-group">
          <label for="discoverCapability">Capability Filter (optional)</label>
          <input type="text" id="discoverCapability" placeholder="render">
        </div>
        <button id="discoverBtn" class="primary" disabled>Discover Actors</button>

        <div id="discoveredActors" class="discovered-actors" style="margin-top: 16px; display: none;">
          <!-- Discovered actors will appear here -->
        </div>
      </div>
    </div>

    <!-- Messaging Section -->
    <div class="grid">
      <div class="card">
        <h2>Broadcast Message</h2>
        <div class="form-group">
          <label for="broadcastFrom">From Actor</label>
          <input type="text" id="broadcastFrom" placeholder="Select registered actor">
        </div>
        <div class="form-group">
          <label for="broadcastType">Message Type</label>
          <input type="text" id="broadcastType" value="system:announcement" placeholder="system:announcement">
        </div>
        <div class="form-group">
          <label for="broadcastData">Message Data (JSON)</label>
          <textarea id="broadcastData">{ "text": "Hello all actors!", "timestamp": 0 }</textarea>
        </div>
        <div class="form-group">
          <label>
            <input type="checkbox" id="broadcastExcludeSelf"> Exclude self from broadcast
          </label>
        </div>
        <button id="broadcastBtn" class="primary" disabled>Broadcast to All</button>
      </div>

      <div class="card">
        <h2>Pub/Sub Messaging</h2>

        <div class="form-group">
          <label for="subscribeTopic">Topic Name</label>
          <input type="text" id="subscribeTopic" value="events" placeholder="events">
        </div>
        <div class="form-group">
          <label for="subscribeFrom">From Actor</label>
          <input type="text" id="subscribeFrom" placeholder="Select registered actor">
        </div>
        <button id="subscribeBtn" class="success" disabled>Subscribe to Topic</button>

        <h2 style="margin-top: 20px;">Active Subscriptions</h2>
        <div id="subscriptionList" style="margin-bottom: 20px;">
          <div class="empty-state">No active subscriptions</div>
        </div>

        <h2>Publish to Topic</h2>
        <div class="form-group">
          <label for="publishTopic">Topic</label>
          <input type="text" id="publishTopic" value="events" placeholder="events">
        </div>
        <div class="form-group">
          <label for="publishFrom">From Actor</label>
          <input type="text" id="publishFrom" placeholder="Select registered actor">
        </div>
        <div class="form-group">
          <label for="publishType">Message Type</label>
          <input type="text" id="publishType" value="user:action" placeholder="user:action">
        </div>
        <div class="form-group">
          <label for="publishData">Message Data (JSON)</label>
          <textarea id="publishData">{ "action": "click", "target": "button-1" }</textarea>
        </div>
        <button id="publishBtn" class="primary" disabled>Publish Message</button>
      </div>
    </div>

    <!-- Activity Log -->
    <div class="card">
      <h2>Activity Log</h2>
      <div class="log-container" id="logContainer">
        <!-- Log entries will appear here -->
      </div>
      <div class="btn-group" style="margin-top: 12px;">
        <button id="clearLogBtn" class="secondary">Clear Log</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { SignalHubClient, generateBrowserAddress } from '../dist/index.js';

    // State
    let client = null;
    const registeredActors = new Map(); // address -> capabilities
    const subscriptions = new Map(); // topic -> subscriptionId

    // DOM Elements
    const $ = (id) => document.getElementById(id);
    const hubUrl = $('hubUrl');
    const hubJwt = $('hubJwt');
    const connectBtn = $('connectBtn');
    const disconnectBtn = $('disconnectBtn');
    const connectionState = $('connectionState');
    const sessionId = $('sessionId');
    const serverVersion = $('serverVersion');
    const actorIdentity = $('actorIdentity');
    const actorAddress = $('actorAddress');
    const capabilities = $('capabilities');
    const registerActorBtn = $('registerActorBtn');
    const actorList = $('actorList');
    const discoverPattern = $('discoverPattern');
    const discoverCapability = $('discoverCapability');
    const discoverBtn = $('discoverBtn');
    const discoveredActors = $('discoveredActors');
    const broadcastFrom = $('broadcastFrom');
    const broadcastType = $('broadcastType');
    const broadcastData = $('broadcastData');
    const broadcastExcludeSelf = $('broadcastExcludeSelf');
    const broadcastBtn = $('broadcastBtn');
    const subscribeTopic = $('subscribeTopic');
    const subscribeFrom = $('subscribeFrom');
    const subscribeBtn = $('subscribeBtn');
    const subscriptionList = $('subscriptionList');
    const publishTopic = $('publishTopic');
    const publishFrom = $('publishFrom');
    const publishType = $('publishType');
    const publishData = $('publishData');
    const publishBtn = $('publishBtn');
    const logContainer = $('logContainer');
    const clearLogBtn = $('clearLogBtn');

    // Logging
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span class="message">${message}</span>`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function updateConnectionState(state) {
      connectionState.textContent = state;
      connectionState.className = `badge ${state}`;
    }

    function updateActorList() {
      if (registeredActors.size === 0) {
        actorList.innerHTML = '<div class="empty-state">No actors registered</div>';
      } else {
        actorList.innerHTML = Array.from(registeredActors.entries())
          .map(([addr, caps]) => `
            <div class="actor-item">
              <span>${addr}</span>
              <span class="remove" data-address="${addr}">×</span>
            </div>
          `).join('');

        // Add remove handlers
        actorList.querySelectorAll('.remove').forEach(btn => {
          btn.addEventListener('click', () => unregisterActor(btn.dataset.address));
        });
      }

      // Update dropdowns
      const actors = Array.from(registeredActors.keys());
      if (actors.length > 0) {
        if (!broadcastFrom.value) broadcastFrom.value = actors[0];
        if (!subscribeFrom.value) subscribeFrom.value = actors[0];
        if (!publishFrom.value) publishFrom.value = actors[0];
      }
    }

    function updateSubscriptionList() {
      if (subscriptions.size === 0) {
        subscriptionList.innerHTML = '<div class="empty-state">No active subscriptions</div>';
      } else {
        subscriptionList.innerHTML = Array.from(subscriptions.entries())
          .map(([topic, subId]) => `
            <div class="subscription-item">
              <div>
                <div class="topic">${topic}</div>
                <div class="id">ID: ${subId}</div>
              </div>
              <button class="danger" data-subid="${subId}" data-topic="${topic}" style="padding: 4px 12px; font-size: 12px;">Unsubscribe</button>
            </div>
          `).join('');

        // Add unsubscribe handlers
        subscriptionList.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => unsubscribe(btn.dataset.topic, btn.dataset.subid));
        });
      }
    }

    // Connect
    connectBtn.addEventListener('click', async () => {
      const url = hubUrl.value.trim();
      const jwt = hubJwt.value.trim();

      if (!url) {
        log('Please enter Signal Hub URL', 'error');
        return;
      }

      try {
        log('Creating Signal Hub client...', 'info');
        client = new SignalHubClient({
          url,
          jwt,
          autoReconnect: true,
          heartbeatInterval: 25000
        });

        // Event handlers
        client.on('connected', (event) => {
          log('✓ Connected to Signal Hub', 'success');
          sessionId.textContent = event.sessionId || '-';
          serverVersion.textContent = event.serverVersion || '-';
          actorIdentity.textContent = event.actorIdentity || '-';
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          registerActorBtn.disabled = false;
          discoverBtn.disabled = false;
        });

        client.on('disconnected', () => {
          log('✗ Disconnected from Signal Hub', 'warning');
          sessionId.textContent = '-';
          serverVersion.textContent = '-';
          actorIdentity.textContent = '-';
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          registerActorBtn.disabled = true;
          discoverBtn.disabled = true;
          broadcastBtn.disabled = true;
          subscribeBtn.disabled = true;
          publishBtn.disabled = true;
        });

        client.on('error', (event) => {
          log(`✗ Error: ${event.message}${event.code ? ` (${event.code})` : ''}`, 'error');
        });

        client.on('stateChange', (state) => {
          updateConnectionState(state);
        });

        client.on('message', (event) => {
          const msg = event.message;

          // Handle different message types
          if (msg.type === 'hub:broadcast_ack') {
            log(`✓ Broadcast acknowledged: ${msg.payload.deliveredCount} actors reached`, 'success');
          } else if (msg.type === 'hub:published') {
            log(`✓ Published to ${msg.payload.subscriberCount} subscribers`, 'success');
          } else if (msg.type.startsWith('hub:')) {
            log(`← Hub message: ${msg.type}`, 'info');
          } else {
            log(`← Received ${msg.type} from ${msg.from}`, 'success');
            log(`   Payload: ${JSON.stringify(msg.payload, null, 2)}`, 'info');
          }
        });

        log('Connecting to Signal Hub...', 'info');
        await client.connect();
      } catch (error) {
        log(`✗ Connection failed: ${error.message}`, 'error');
      }
    });

    // Disconnect
    disconnectBtn.addEventListener('click', async () => {
      try {
        log('Disconnecting...', 'info');
        await client.disconnect();
        client = null;
        registeredActors.clear();
        subscriptions.clear();
        updateActorList();
        updateSubscriptionList();
      } catch (error) {
        log(`✗ Disconnect failed: ${error.message}`, 'error');
      }
    });

    // Register actor
    registerActorBtn.addEventListener('click', async () => {
      try {
        const address = actorAddress.value.trim() || generateBrowserAddress();
        const caps = capabilities.value
          .split(',')
          .map(c => c.trim())
          .filter(c => c);

        log(`Registering actor ${address}...`, 'info');
        const registeredAddress = await client.registerActor({
          address,
          capabilities: caps,
          metadata: { registeredAt: Date.now() }
        });

        registeredActors.set(registeredAddress, caps);
        updateActorList();
        log(`✓ Actor registered: ${registeredAddress}`, 'success');

        // Enable messaging buttons
        broadcastBtn.disabled = false;
        subscribeBtn.disabled = false;
        publishBtn.disabled = false;

        // Clear form
        actorAddress.value = '';
      } catch (error) {
        log(`✗ Registration failed: ${error.message}`, 'error');
      }
    });

    // Unregister actor
    async function unregisterActor(address) {
      try {
        log(`Unregistering actor ${address}...`, 'info');
        await client.unregisterActor(address);
        registeredActors.delete(address);
        updateActorList();
        log(`✓ Actor unregistered: ${address}`, 'success');

        // Disable buttons if no actors left
        if (registeredActors.size === 0) {
          broadcastBtn.disabled = true;
          subscribeBtn.disabled = true;
          publishBtn.disabled = true;
        }
      } catch (error) {
        log(`✗ Unregister failed: ${error.message}`, 'error');
      }
    }

    // Discover actors
    discoverBtn.addEventListener('click', async () => {
      try {
        const pattern = discoverPattern.value.trim() || '*';
        const capability = discoverCapability.value.trim() || undefined;
        const from = registeredActors.size > 0
          ? Array.from(registeredActors.keys())[0]
          : actorIdentity.textContent;

        log(`Discovering actors with pattern "${pattern}"${capability ? ` and capability "${capability}"` : ''}...`, 'info');
        const actors = await client.discover(from, pattern, capability);

        discoveredActors.style.display = 'block';
        if (actors.length === 0) {
          discoveredActors.innerHTML = '<div class="empty-state">No actors found</div>';
          log('No actors found', 'warning');
        } else {
          discoveredActors.innerHTML = actors.map(actor => `
            <div class="discovered-actor">
              <div class="address">${actor.address}</div>
              <div class="caps">Capabilities: ${actor.capabilities.join(', ') || 'none'}</div>
            </div>
          `).join('');
          log(`✓ Discovered ${actors.length} actor(s)`, 'success');
        }
      } catch (error) {
        log(`✗ Discovery failed: ${error.message}`, 'error');
      }
    });

    // Broadcast
    broadcastBtn.addEventListener('click', async () => {
      try {
        const from = broadcastFrom.value.trim();
        const type = broadcastType.value.trim();
        const dataText = broadcastData.value.replace('"timestamp": 0', `"timestamp": ${Date.now()}`);
        const data = JSON.parse(dataText);
        const excludeSelf = broadcastExcludeSelf.checked;

        if (!from || !type) {
          log('Please fill in all broadcast fields', 'error');
          return;
        }

        log(`Broadcasting ${type} to all actors...`, 'info');
        await client.broadcast(from, type, data, { excludeSelf });
        log('✓ Broadcast sent', 'success');
      } catch (error) {
        log(`✗ Broadcast failed: ${error.message}`, 'error');
      }
    });

    // Subscribe
    subscribeBtn.addEventListener('click', async () => {
      try {
        const topic = subscribeTopic.value.trim();
        const from = subscribeFrom.value.trim();

        if (!topic || !from) {
          log('Please fill in topic and actor', 'error');
          return;
        }

        if (subscriptions.has(topic)) {
          log(`Already subscribed to topic "${topic}"`, 'warning');
          return;
        }

        log(`Subscribing to topic "${topic}"...`, 'info');
        const subId = await client.subscribe(from, topic, false);
        subscriptions.set(topic, subId);
        updateSubscriptionList();
        log(`✓ Subscribed to "${topic}" (ID: ${subId})`, 'success');
      } catch (error) {
        log(`✗ Subscribe failed: ${error.message}`, 'error');
      }
    });

    // Unsubscribe
    async function unsubscribe(topic, subId) {
      try {
        const from = subscribeFrom.value.trim();

        log(`Unsubscribing from topic "${topic}"...`, 'info');
        await client.unsubscribe(from, subId);
        subscriptions.delete(topic);
        updateSubscriptionList();
        log(`✓ Unsubscribed from "${topic}"`, 'success');
      } catch (error) {
        log(`✗ Unsubscribe failed: ${error.message}`, 'error');
      }
    }

    // Publish
    publishBtn.addEventListener('click', async () => {
      try {
        const topic = publishTopic.value.trim();
        const from = publishFrom.value.trim();
        const type = publishType.value.trim();
        const dataText = publishData.value;
        const data = JSON.parse(dataText);

        if (!topic || !from || !type) {
          log('Please fill in all publish fields', 'error');
          return;
        }

        log(`Publishing ${type} to topic "${topic}"...`, 'info');
        await client.publish(from, topic, type, data);
        log('✓ Message published', 'success');
      } catch (error) {
        log(`✗ Publish failed: ${error.message}`, 'error');
      }
    });

    // Clear log
    clearLogBtn.addEventListener('click', () => {
      logContainer.innerHTML = '';
      log('Log cleared', 'info');
    });

    // Initial state
    log('Signal Hub Demo - Ready', 'info');
    log('Configure connection and click Connect to begin', 'info');
  </script>
</body>
</html>
