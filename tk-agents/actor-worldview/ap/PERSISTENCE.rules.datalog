# Persistence Mapping Rules

# Is a node "Physical"? (Does it have a backing store?)
is_physical(node_id, uri) :- property{node_id: node_id, key: 'origin_uri', value: uri}

# Determine the Effect Actor needed for a URI
# e.g., fs:// -> FileEffectActor, web:// -> WebEffectActor
effect_handler(node_id, 'FileEffectActor') :- is_physical(node_id, uri), regex_match(uri, '^fs://')
effect_handler(node_id, 'WebEffectActor') :- is_physical(node_id, uri), regex_match(uri, '^web://')

# Sync Priority: Which nodes need immediate flushing to disk?
# High priority if it's a 'code' node or 'config' node.
sync_priority(node_id, 'high') :- property{node_id: node_id, key: 'type', value: 'code'}
sync_priority(node_id, 'high') :- property{node_id: node_id, key: 'type', value: 'config'}
sync_priority(node_id, 'low')  :- property{node_id: node_id, key: 'type', value: 'cache'}

# Fragmentation Rule: Find all children of a document that need syncing
needs_sync(child_id) :-
    edge{from_node: doc_id, to_node: child_id, edge_type: 'contains'},
    is_physical(doc_id, _),
    stale_node(child_id) # Uses the rule from GRAPH_RULES.datalog
