# REPL & Dialogue Rules

# Sessions: user_id, session_id, current_agent_id
:create session {
    user_id: uuid,
    session_id: uuid,
    =>
    agent_id: uuid,
    status: string
}

# Message Context: Linking messages to graph nodes discussed
:create message_context {
    message_id: uuid,
    node_id: uuid
}

# Auto-Context: Find nodes frequently discussed in the last 5 minutes
active_context(session_id, node_id) :-
    session{session_id: session_id, user_id: U},
    log_entry{log_id: L, ts: T, payload: P},
    T > now - 300, # Last 5 minutes
    message_context{message_id: P.id, node_id: node_id}

# Routing: Who is the active agent for this user?
active_agent(user_id, agent_id) :-
    session{user_id: user_id, status: 'active', agent_id: agent_id}

# Cleanup: Close sessions with no input for 1 hour
stale_session(session_id) :-
    session{session_id: session_id},
    property{node_id: session_id, key: 'last_input_ts', value: T},
    T < now - 3600
