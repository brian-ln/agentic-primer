% ============================================================================
% Actor Send Semantics - Corrected Model
% ============================================================================
% Reflects the fundamental design:
% - All actors have .send() operation (external API)
% - All actors have receive handler (internal implementation)
% - System forwards using .send() on target actors
% - No "route" - just "send" everywhere

% ============================================================================
% 1. UNIVERSAL SEND OPERATION
% ============================================================================

% Every actor has a send operation
has_send_operation(ActorID) :- actor_exists(ActorID).

% System has send operation (it's an actor!)
has_send_operation(SystemID) :- is_system(SystemID).

% Send is the universal interface
universal_interface(send).

% All actors implement the universal interface
implements_interface(ActorID, send) :- has_send_operation(ActorID).

% ============================================================================
% 2. INTERNAL RECEIVE HANDLER
% ============================================================================

% Every actor has internal receive handler
has_receive_handler(ActorID) :- actor_exists(ActorID).

% Receive is internal implementation detail
is_internal(receive).

% Send operation delegates to receive handler
send_delegates_to_receive(ActorID) :-
    has_send_operation(ActorID),
    has_receive_handler(ActorID).

% ============================================================================
% 3. MESSAGE SENDING PATTERNS
% ============================================================================

% Pattern 1: Direct send to actor
send_direct(SenderID, ActorID, Message) :-
    actor_exists(SenderID),
    has_send_operation(ActorID),
    sends_message(SenderID, ActorID, Message).

% Pattern 2: Send via system (system forwards)
send_via_system(SenderID, SystemID, TargetID, Message) :-
    actor_exists(SenderID),
    is_system(SystemID),
    has_send_operation(SystemID),
    registered_in(TargetID, SystemID),
    sends_message(SenderID, SystemID, Message),
    system_forwards_to(SystemID, TargetID, Message).

% System forwards by calling target's send operation
system_forwards_to(SystemID, TargetID, Message) :-
    is_system(SystemID),
    registered_in(TargetID, SystemID),
    has_send_operation(TargetID),
    actor_exists(TargetID).

% ============================================================================
% 4. ACTOR INITIALIZATION PATTERNS
% ============================================================================

% Pattern A: Actor gets System at creation time
actor_initialized_with_system(ActorID, SystemID) :-
    actor_exists(ActorID),
    is_system(SystemID),
    captures_dependency(ActorID, SystemID).

% Pattern B: Actor registers with System at runtime
actor_registered_at_runtime(ActorID, SystemID) :-
    actor_exists(ActorID),
    is_system(SystemID),
    registered_in(ActorID, SystemID),
    \+ captures_dependency(ActorID, SystemID).

% Either pattern gives actor access to system
actor_has_system_access(ActorID, SystemID) :-
    actor_initialized_with_system(ActorID, SystemID).

actor_has_system_access(ActorID, SystemID) :-
    actor_registered_at_runtime(ActorID, SystemID).

% ============================================================================
% 5. INTERACTION PATTERNS (Primary Use Case)
% ============================================================================

% Most interactions are with Systems (not individual actors)
primary_interaction_with_system(UserID, SystemID) :-
    is_user(UserID),
    is_system(SystemID),
    sends_message(UserID, SystemID, _).

% Systems contain other actors
system_contains_actors(SystemID) :-
    is_system(SystemID),
    registered_in(ActorID, SystemID),
    actor_exists(ActorID).

% Systems can contain other systems (nested)
system_contains_systems(SystemID) :-
    is_system(SystemID),
    registered_in(ChildSystemID, SystemID),
    is_system(ChildSystemID).

% Users typically don't interact with individual actors directly
indirect_actor_access(UserID, ActorID) :-
    is_user(UserID),
    actor_exists(ActorID),
    is_system(SystemID),
    registered_in(ActorID, SystemID),
    sends_message(UserID, SystemID, _).

% ============================================================================
% 6. UNIFORM COMPOSITION
% ============================================================================

% Systems are actors (uniform interface)
system_is_actor(SystemID) :-
    is_system(SystemID),
    has_send_operation(SystemID).

% All actors have same interface (send)
same_send_interface(Actor1, Actor2) :-
    has_send_operation(Actor1),
    has_send_operation(Actor2).

% Systems can be nested because they have the same interface
can_nest_systems(ParentSystemID, ChildSystemID) :-
    is_system(ParentSystemID),
    is_system(ChildSystemID),
    same_send_interface(ParentSystemID, ChildSystemID).

% ============================================================================
% 7. INVARIANTS
% ============================================================================

% Invariant: All actors have send operation
all_actors_have_send :-
    forall(actor_exists(ActorID), has_send_operation(ActorID)).

% Invariant: Send delegates to receive
send_receive_invariant :-
    forall(has_send_operation(ActorID), has_receive_handler(ActorID)).

% Invariant: Systems can forward messages
system_forwarding_invariant :-
    forall(
        (is_system(SystemID), registered_in(ActorID, SystemID)),
        system_forwards_to(SystemID, ActorID, _)
    ).

% Invariant: Primary interaction is with systems
primary_interaction_invariant :-
    forall(
        (is_user(UserID), sends_message(UserID, TargetID, _)),
        is_system(TargetID)
    ).

% ============================================================================
% 8. EXAMPLE FACTS
% ============================================================================

% Actors
actor_exists("system").
actor_exists("task-1").
actor_exists("task-2").
actor_exists("subsystem").

% Systems
is_system("system").
is_system("subsystem").

% Users (external code)
is_user("external-typescript-code").

% Registration
registered_in("task-1", "system").
registered_in("task-2", "system").
registered_in("subsystem", "system").

% Initialization patterns
captures_dependency("task-1", "system").  % Created with system
registered_in("task-2", "system").        % Registered at runtime

% Message sending
sends_message("external-typescript-code", "system", msg1).
sends_message("system", "task-1", msg2).

% ============================================================================
% 9. QUERIES
% ============================================================================

% Query: Verify all actors have send
% ?- all_actors_have_send.

% Query: Find actors initialized with system
% ?- actor_initialized_with_system(ActorID, SystemID).

% Query: Find actors registered at runtime
% ?- actor_registered_at_runtime(ActorID, SystemID).

% Query: Show message forwarding
% ?- system_forwards_to(SystemID, TargetID, Message).

% Query: Verify users interact with systems
% ?- primary_interaction_with_system(UserID, SystemID).

% Query: Show nested systems
% ?- can_nest_systems(ParentID, ChildID).

% ============================================================================
% 10. KEY INSIGHTS
% ============================================================================

% Insight 1: send is universal
% Every actor has send, whether it's a simple actor or a system

% Insight 2: receive is internal
% External code never calls receive directly, only send

% Insight 3: System forwards using send
% System doesn't have special "route" operation, just send to target

% Insight 4: Two initialization patterns
% Actor can get system at creation OR register later

% Insight 5: Users interact with systems
% Most code sends to systems, which forward to actors

% Insight 6: Uniform composition
% Systems ARE actors, so they compose uniformly

% ============================================================================
% END
% ============================================================================
