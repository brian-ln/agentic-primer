% ============================================================================
% Task CLI Specification - Formal Verification Model
% ============================================================================
% This Datalog specification captures the behavioral requirements and
% invariants of the Task CLI for programmatic verification.

% ============================================================================
% 1. CORE ENTITIES
% ============================================================================

% Commands exist in the CLI
command_exists(CommandID).

% Tasks exist in the graph
task_exists(TaskID).

% Edges exist between nodes
edge_exists(EdgeID).

% File system state
file_exists(FilePath).

% CLI execution sessions
session_exists(SessionID).

% ============================================================================
% 2. COMMAND DEFINITIONS
% ============================================================================

% All 11 CLI commands
command_exists(init).
command_exists(add).
command_exists(update).
command_exists(delete).
command_exists(list).
command_exists(ready).
command_exists(search).
command_exists(show).
command_exists(status).
command_exists(eval).
command_exists(graph).

% Commands that modify state
modifies_state(init).
modifies_state(add).
modifies_state(update).
modifies_state(delete).

% Commands that require file to exist
requires_file(add).
requires_file(update).
requires_file(delete).
requires_file(list).
requires_file(ready).
requires_file(search).
requires_file(show).
requires_file(status).
requires_file(eval).
requires_file(graph).

% Commands that require task ID
requires_task_id(update).
requires_task_id(delete).
requires_task_id(show).
requires_task_id(status).
requires_task_id(eval).
requires_task_id(graph).

% ============================================================================
% 3. COMMAND ARGUMENT STRUCTURE
% ============================================================================

% Command argument definitions
command_arg(init, []).
command_arg(add, [goal]).
command_arg(update, [id, action]).
command_arg(delete, [id]).
command_arg(list, []).
command_arg(ready, []).
command_arg(search, [query]).
command_arg(show, [id]).
command_arg(status, [id]).
command_arg(eval, [id]).
command_arg(graph, [id]).

% Command options
command_option(add, deliverables, string, "d1,d2,...").
command_option(add, criteria, string, "name:measure:threshold").
command_option(add, depends, string, "id1,id2,...").
command_option(add, parent, string, "id").
command_option(add, labels, string, "tag1,tag2,...").
command_option(add, priority, string, "P0|P1|P2|P3|P4").

command_option(list, status, string, "state").
command_option(list, label, string, "label").
command_option(list, priority, string, "P0-P4").

command_option(delete, force, boolean, nil).

% Update actions
update_action(start).
update_action(complete).
update_action(block).

% ============================================================================
% 4. TASK STATE MACHINE
% ============================================================================

% Task states
task_state(created).
task_state(ready).
task_state(active).
task_state(blocked).
task_state(completed).
task_state(failed).

% Valid state transitions
can_transition(created, active, start).
can_transition(created, blocked, block).
can_transition(ready, active, start).
can_transition(ready, blocked, block).
can_transition(active, completed, complete).
can_transition(active, blocked, block).
can_transition(active, failed, fail).
can_transition(blocked, active, unblock).

% Terminal states (no transitions out)
is_terminal_state(completed).
is_terminal_state(failed).

% INVARIANT: Terminal states have no outgoing transitions
terminal_state_invariant :-
    forall(
        is_terminal_state(State),
        \+ can_transition(State, _, _)
    ).

% ============================================================================
% 5. PRIORITY SYSTEM
% ============================================================================

% Valid priority values
valid_priority(0).
valid_priority(1).
valid_priority(2).
valid_priority(3).
valid_priority(4).

% Priority display format
priority_display(0, "P0").
priority_display(1, "P1").
priority_display(2, "P2").
priority_display(3, "P3").
priority_display(4, "P4").

% Priority ordering (lower = higher priority)
higher_priority(P1, P2) :- valid_priority(P1), valid_priority(P2), P1 < P2.

% ============================================================================
% 6. EDGE TYPES
% ============================================================================

% Valid edge types
edge_type(depends_on).
edge_type(requires_knowledge).
edge_type(produces).
edge_type(spawned_by).
edge_type(blocks).
edge_type(references).

% Edge semantics
edge_creates_blocker(depends_on).
edge_creates_parent(spawned_by).

% ============================================================================
% 7. FILTER SEMANTICS
% ============================================================================

% Filter definition
filter_type(status_filter).
filter_type(label_filter).
filter_type(priority_filter).

% Filter combination semantics (AND logic)
filters_combine_with_and(list).

% Filter application
task_matches_filter(TaskID, status_filter, Value) :-
    task_exists(TaskID),
    task_state(TaskID, State),
    State = Value.

task_matches_filter(TaskID, label_filter, Value) :-
    task_exists(TaskID),
    task_has_label(TaskID, Label),
    string_equal_ignore_case(Label, Value).

task_matches_filter(TaskID, priority_filter, Value) :-
    task_exists(TaskID),
    task_priority(TaskID, Priority),
    Priority = Value.

% Task matches all filters (AND semantics)
task_matches_all_filters(TaskID, Filters) :-
    task_exists(TaskID),
    forall(
        member((FilterType, Value), Filters),
        task_matches_filter(TaskID, FilterType, Value)
    ).

% ============================================================================
% 8. READY TASK CRITERIA
% ============================================================================

% Task is not in terminal or blocked state
task_state_allows_work(TaskID) :-
    task_exists(TaskID),
    task_state(TaskID, State),
    \+ is_terminal_state(State),
    State \= blocked.

% Task dependencies are all completed
all_dependencies_completed(TaskID) :-
    task_exists(TaskID),
    forall(
        (edge_exists(EdgeID), edge_from(EdgeID, TaskID), edge_type(EdgeID, depends_on), edge_to(EdgeID, DepID)),
        (task_exists(DepID), task_state(DepID, completed))
    ).

% Task is ready to work on
task_is_ready(TaskID) :-
    task_exists(TaskID),
    task_state_allows_work(TaskID),
    all_dependencies_completed(TaskID).

% INVARIANT: Ready tasks have no incomplete dependencies
ready_task_invariant :-
    forall(
        task_is_ready(TaskID),
        all_dependencies_completed(TaskID)
    ).

% ============================================================================
% 9. SEARCH SEMANTICS
% ============================================================================

% Searchable fields
searchable_field(goal).
searchable_field(deliverables).
searchable_field(objective_criteria).

% Search match (case-insensitive substring)
search_matches(TaskID, Query, MatchedField) :-
    task_exists(TaskID),
    searchable_field(MatchedField),
    task_field_value(TaskID, MatchedField, Value),
    contains_substring_ignore_case(Value, Query).

% Task matches search query (any field match)
task_matches_search(TaskID, Query) :-
    task_exists(TaskID),
    search_matches(TaskID, Query, _).

% ============================================================================
% 10. COMMAND PRECONDITIONS
% ============================================================================

% Init precondition: file must NOT exist
precondition_met(init) :-
    \+ file_exists("tasks.json").

% Commands requiring file: file must exist
precondition_met(Command) :-
    requires_file(Command),
    file_exists("tasks.json").

% Commands requiring task ID: task must exist
precondition_met(Command, TaskID) :-
    requires_task_id(Command),
    task_exists(TaskID).

% Delete safety: requires confirmation unless forced
delete_safe(TaskID, Force) :-
    (Force = true ; user_confirmed_deletion(TaskID)).

% INVARIANT: Commands only execute when preconditions met
precondition_invariant :-
    forall(
        (command_executed(SessionID, Command), command_args(SessionID, Args)),
        preconditions_satisfied(Command, Args)
    ).

% ============================================================================
% 11. COMMAND POSTCONDITIONS
% ============================================================================

% Init postcondition: file exists with at least one task
postcondition_init :-
    file_exists("tasks.json"),
    task_count(Count),
    Count >= 1.

% Add postcondition: new task exists with correct properties
postcondition_add(TaskID, Goal, Options) :-
    task_exists(TaskID),
    task_goal(TaskID, Goal),
    (member(depends, Options) -> dependencies_created(TaskID, Options) ; true),
    (member(parent, Options) -> parent_edge_created(TaskID, Options) ; true).

% Delete postcondition: task and edges removed
postcondition_delete(TaskID) :-
    \+ task_exists(TaskID),
    \+ edge_from(_, TaskID),
    \+ edge_to(_, TaskID).

% Update postcondition: state transitioned correctly
postcondition_update(TaskID, Action, NewState) :-
    task_exists(TaskID),
    task_state(TaskID, NewState),
    valid_transition_occurred(TaskID, Action, NewState).

% ============================================================================
% 12. DISPLAY FORMATTING RULES
% ============================================================================

% Status emoji mapping
status_emoji(created, "o").
status_emoji(ready, "yellow_circle").
status_emoji(active, "arrows_counterclockwise").
status_emoji(blocked, "no_entry_sign").
status_emoji(completed, "white_check_mark").
status_emoji(failed, "x").
status_emoji(unknown, "question").

% List display format
list_display_format([emoji, priority, id, state, goal_preview, labels]).

% Field widths
display_field_width(id, 15).
display_field_width(state, 10).

% Goal preview truncation
goal_preview_max_length(50).

% ============================================================================
% 13. GRAPH VISUALIZATION RULES
% ============================================================================

% Tree rendering
tree_connector(branch, "|-- ").
tree_connector(last_branch, "+-- ").
tree_connector(continuation, "|   ").
tree_connector(space, "    ").

% Cycle detection
has_cycle(TaskID) :-
    reachable(TaskID, TaskID, depends_on).

% Reachability via edge type
reachable(From, To, EdgeType) :-
    edge_from(EdgeID, From),
    edge_type(EdgeID, EdgeType),
    edge_to(EdgeID, To).

reachable(From, To, EdgeType) :-
    edge_from(EdgeID, From),
    edge_type(EdgeID, EdgeType),
    edge_to(EdgeID, Mid),
    reachable(Mid, To, EdgeType).

% INVARIANT: Cycles are detected and reported
cycle_detection_invariant :-
    forall(
        has_cycle(TaskID),
        cycle_warning_displayed(TaskID)
    ).

% ============================================================================
% 14. FILE I/O INVARIANTS
% ============================================================================

% File format validity
valid_task_file(FilePath) :-
    file_exists(FilePath),
    file_content_is_json(FilePath),
    json_has_nodes_array(FilePath),
    json_has_edges_array(FilePath).

% Save/load round-trip consistency
round_trip_consistent(Graph) :-
    dump_graph(Graph, DumpedData),
    load_graph(DumpedData, RestoredGraph),
    graphs_equivalent(Graph, RestoredGraph).

% INVARIANT: File operations maintain data integrity
file_integrity_invariant :-
    forall(
        (save_graph(Graph, FilePath), load_graph(FilePath, LoadedGraph)),
        graphs_equivalent(Graph, LoadedGraph)
    ).

% ============================================================================
% 15. COMPLETE CRITERIA EVALUATION
% ============================================================================

% Criterion passes based on type
criterion_passes(Criterion) :-
    criterion_threshold(Criterion, Threshold),
    criterion_actual(Criterion, Actual),
    (
        (is_boolean(Threshold), Actual = Threshold) ;
        (is_number(Threshold), is_number(Actual), Actual >= Threshold)
    ).

% All criteria passed
all_criteria_passed(TaskID) :-
    task_exists(TaskID),
    forall(
        task_criterion(TaskID, Criterion),
        criterion_passes(Criterion)
    ).

% Task can complete
can_complete(TaskID) :-
    task_exists(TaskID),
    task_state(TaskID, active),
    all_criteria_passed(TaskID).

% INVARIANT: Complete transition requires all criteria passed
complete_requires_criteria_invariant :-
    forall(
        (task_state_changed(TaskID, OldState, completed), OldState = active),
        all_criteria_passed(TaskID)
    ).

% ============================================================================
% 16. SAFETY MECHANISMS
% ============================================================================

% Delete requires confirmation
delete_requires_confirmation(TaskID) :-
    task_exists(TaskID),
    \+ force_flag_set.

% Confirmation displayed
confirmation_displayed(TaskID) :-
    delete_requires_confirmation(TaskID),
    displayed_task_summary(TaskID),
    displayed_connected_edges(TaskID),
    displayed_confirmation_prompt.

% User confirmed
user_confirmed(yes).
user_rejected(no).

% INVARIANT: Destructive operations require confirmation unless forced
safety_invariant :-
    forall(
        (command_executed(SessionID, delete), command_args(SessionID, [TaskID | Rest])),
        (member(force, Rest) ; confirmation_received(SessionID, yes))
    ).

% ============================================================================
% 17. ERROR HANDLING
% ============================================================================

% Error types
error_type(file_not_found).
error_type(task_not_found).
error_type(invalid_priority).
error_type(invalid_action).
error_type(invalid_status).
error_type(already_exists).

% Error exit codes
error_exit_code(file_not_found, 1).
error_exit_code(task_not_found, 1).
error_exit_code(invalid_priority, 1).
error_exit_code(invalid_action, 1).
error_exit_code(invalid_status, 1).
error_exit_code(already_exists, 1).
error_exit_code(success, 0).

% Error message format
error_format("Error: ~a").

% INVARIANT: Errors produce correct exit code
error_handling_invariant :-
    forall(
        (error_occurred(SessionID, ErrorType), session_exit_code(SessionID, ExitCode)),
        error_exit_code(ErrorType, ExitCode)
    ).

% ============================================================================
% 18. COMMAND COMPOSITION RULES
% ============================================================================

% Prerequisite relationships
requires_init(add).
requires_init(update).
requires_init(delete).
requires_init(list).
requires_init(ready).
requires_init(search).
requires_init(show).
requires_init(status).
requires_init(eval).
requires_init(graph).

% Add required before task-specific commands
requires_task(update).
requires_task(delete).
requires_task(show).
requires_task(status).
requires_task(eval).
requires_task(graph).

% Valid command sequence
valid_sequence([]).
valid_sequence([init | Rest]) :- valid_sequence_after_init(Rest).
valid_sequence_after_init([]).
valid_sequence_after_init([Command | Rest]) :-
    command_exists(Command),
    Command \= init,
    valid_sequence_after_init(Rest).

% ============================================================================
% 19. VERIFICATION QUERIES
% ============================================================================

% Query: Verify terminal state invariant
% ?- terminal_state_invariant.

% Query: Verify ready task invariant
% ?- ready_task_invariant.

% Query: Verify precondition invariant
% ?- precondition_invariant.

% Query: Verify cycle detection invariant
% ?- cycle_detection_invariant.

% Query: Verify file integrity invariant
% ?- file_integrity_invariant.

% Query: Verify complete requires criteria invariant
% ?- complete_requires_criteria_invariant.

% Query: Verify safety invariant
% ?- safety_invariant.

% Query: Verify error handling invariant
% ?- error_handling_invariant.

% Query: Find all ready tasks
% ?- task_is_ready(TaskID).

% Query: Find tasks matching search
% ?- task_matches_search(TaskID, "authentication").

% Query: Check if task can complete
% ?- can_complete(TaskID).

% Query: Find cycles in dependency graph
% ?- has_cycle(TaskID).

% ============================================================================
% 20. COMPLETENESS CHECKS
% ============================================================================

% All commands have definitions
all_commands_defined :-
    forall(
        command_exists(Command),
        command_arg(Command, _)
    ).

% All states have emoji
all_states_have_emoji :-
    forall(
        task_state(State),
        status_emoji(State, _)
    ).

% All priorities are valid
all_priorities_valid :-
    forall(
        task_priority(_, Priority),
        valid_priority(Priority)
    ).

% CLI is well-formed
cli_well_formed :-
    all_commands_defined,
    all_states_have_emoji,
    all_priorities_valid,
    terminal_state_invariant,
    ready_task_invariant.

% All invariants hold
all_invariants_hold :-
    terminal_state_invariant,
    ready_task_invariant,
    precondition_invariant,
    cycle_detection_invariant,
    file_integrity_invariant,
    complete_requires_criteria_invariant,
    safety_invariant,
    error_handling_invariant.

% ============================================================================
% 21. EXAMPLE FACTS (for testing)
% ============================================================================

% Example file system state
file_exists("tasks.json").

% Example tasks
task_exists("task_1").
task_exists("task_2").
task_exists("task_3").

% Task states
task_state("task_1", active).
task_state("task_2", created).
task_state("task_3", completed).

% Task priorities
task_priority("task_1", 0).
task_priority("task_2", 1).

% Task labels
task_has_label("task_1", "backend").
task_has_label("task_1", "auth").
task_has_label("task_2", "testing").

% Task goals
task_goal("task_1", "Build authentication module").
task_goal("task_2", "Write unit tests").
task_goal("task_3", "Setup project structure").

% Edges
edge_exists("edge_1").
edge_from("edge_1", "task_1").
edge_to("edge_1", "task_3").
edge_type("edge_1", depends_on).

edge_exists("edge_2").
edge_from("edge_2", "task_2").
edge_to("edge_2", "task_1").
edge_type("edge_2", depends_on).

% ============================================================================
% END
% ============================================================================
