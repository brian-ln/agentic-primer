% ============================================================================
% Actor System Specification - Formal Verification Model
% ============================================================================
% This Datalog specification captures the behavioral requirements and
% invariants of the actor system for programmatic verification.

% ============================================================================
% 1. CORE ENTITIES
% ============================================================================

% Actors exist in the system
actor_exists(ActorID).

% Systems exist (systems are actors)
system_exists(SystemID) :- actor_exists(SystemID), is_system(SystemID).

% Actor factories create actors
actor_factory(FactoryID).

% Send functions exist as implementations
send_function(SendFnID).

% ============================================================================
% 2. PURE FUNCTION INVARIANT
% ============================================================================

% Actor is created by factory with explicit dependencies
actor_created_by(ActorID, FactoryID, Dependencies) :-
    actor_exists(ActorID),
    actor_factory(FactoryID),
    has_dependencies(ActorID, Dependencies).

% Dependencies are explicit (passed as parameters)
has_explicit_dependency(ActorID, DepID) :-
    has_dependencies(ActorID, Dependencies),
    member(DepID, Dependencies).

% Pure function: No hidden dependencies
is_pure_function(ActorID) :-
    actor_exists(ActorID),
    forall(
        depends_on(ActorID, DepID),
        has_explicit_dependency(ActorID, DepID)
    ).

% INVARIANT: All actors are pure functions
pure_function_invariant :-
    forall(actor_exists(ActorID), is_pure_function(ActorID)).

% ============================================================================
% 3. SEND INJECTION INVARIANT
% ============================================================================

% Actor receives send function at creation
actor_receives_send(ActorID, SendFnID) :-
    actor_exists(ActorID),
    send_function(SendFnID),
    has_explicit_dependency(ActorID, SendFnID).

% Send function is in actor's scope
send_in_scope(ActorID, SendFnID) :-
    actor_receives_send(ActorID, SendFnID).

% INVARIANT: All actors have send in scope
send_injection_invariant :-
    forall(
        actor_exists(ActorID),
        exists(SendFnID, send_in_scope(ActorID, SendFnID))
    ).

% ============================================================================
% 4. THE SEND PRIMITIVE
% ============================================================================

% Send operation signature: send(targetId, message)
send_operation(SendFnID, TargetID, Message) :-
    send_function(SendFnID),
    actor_exists(TargetID),
    is_message(Message).

% Send primitive has two parameters
send_has_target_param(SendFnID) :- send_function(SendFnID).
send_has_message_param(SendFnID) :- send_function(SendFnID).

% Send returns Response
send_returns_response(SendFnID) :- send_function(SendFnID).

% INVARIANT: Send is the only messaging primitive
send_primitive_invariant :-
    forall(
        (actor_exists(ActorID), sends_message(ActorID, _, _)),
        exists(SendFnID, send_in_scope(ActorID, SendFnID))
    ).

% ============================================================================
% 5. SYSTEM PROVIDES SEND IMPLEMENTATION
% ============================================================================

% System provides send implementation
system_provides_send(SystemID, SendFnID) :-
    system_exists(SystemID),
    send_function(SendFnID),
    implements(SystemID, SendFnID).

% System maintains registry (address â†’ actor mapping)
system_has_registry(SystemID) :-
    system_exists(SystemID).

% System can register actors
can_register_actor(SystemID, ActorID) :-
    system_exists(SystemID),
    actor_exists(ActorID).

% Actor is registered in system
registered_in(ActorID, SystemID) :-
    actor_exists(ActorID),
    system_exists(SystemID),
    can_register_actor(SystemID, ActorID).

% System routes message to registered actor
system_routes_to(SystemID, TargetID, Message) :-
    system_exists(SystemID),
    registered_in(TargetID, SystemID),
    is_message(Message).

% INVARIANT: Systems provide send implementation
system_send_invariant :-
    forall(
        system_exists(SystemID),
        exists(SendFnID, system_provides_send(SystemID, SendFnID))
    ).

% ============================================================================
% 6. TWO APIs: BRIDGE AND INTERNAL
% ============================================================================

% External API: actor.send(message) - bridge into actor world
external_send(CallerID, ActorID, Message) :-
    is_external_code(CallerID),
    actor_exists(ActorID),
    is_message(Message),
    calls_method(CallerID, ActorID, send, Message).

% Internal API: send(targetId, message) - inside actor world
internal_send(ActorID, TargetID, Message) :-
    actor_exists(ActorID),
    actor_exists(TargetID),
    is_message(Message),
    send_in_scope(ActorID, SendFnID),
    calls_function(ActorID, SendFnID, TargetID, Message).

% Bridge distinguishes external from internal
is_bridge_call(CallerID, ActorID, Message) :-
    external_send(CallerID, ActorID, Message).

is_internal_call(ActorID, TargetID, Message) :-
    internal_send(ActorID, TargetID, Message).

% INVARIANT: External code uses actor.send(), actors use send()
bridge_invariant :-
    forall(
        (is_external_code(CallerID), sends_to_actor(CallerID, ActorID, _)),
        is_bridge_call(CallerID, ActorID, _)
    ),
    forall(
        (actor_exists(ActorID), sends_to_actor(ActorID, TargetID, _), ActorID \= TargetID),
        is_internal_call(ActorID, TargetID, _)
    ).

% ============================================================================
% 7. UNIFORM COMPOSITION
% ============================================================================

% Systems are actors (have .send() method)
system_is_actor(SystemID) :-
    system_exists(SystemID),
    actor_exists(SystemID),
    has_method(SystemID, send).

% System can be registered in another system
system_in_system(SubSystemID, ParentSystemID) :-
    system_exists(SubSystemID),
    system_exists(ParentSystemID),
    registered_in(SubSystemID, ParentSystemID).

% Nested systems compose uniformly
uniform_composition(ParentID, ChildID) :-
    system_exists(ParentID),
    system_exists(ChildID),
    system_in_system(ChildID, ParentID),
    system_is_actor(ChildID).

% INVARIANT: Systems can contain systems
composition_invariant :-
    forall(
        (system_exists(ParentID), system_exists(ChildID)),
        can_register_actor(ParentID, ChildID)
    ).

% ============================================================================
% 8. ADDRESSING INVARIANT
% ============================================================================

% Send implementation is opaque to sender
send_implementation_opaque(ActorID, SendFnID) :-
    actor_exists(ActorID),
    send_in_scope(ActorID, SendFnID),
    % Actor doesn't know how send is implemented
    \+ knows_implementation(ActorID, SendFnID).

% Routing mechanism is irrelevant to actor
routing_irrelevant_to(ActorID) :-
    actor_exists(ActorID),
    send_in_scope(ActorID, SendFnID),
    % Actor just calls send(targetId, message)
    \+ knows_routing_mechanism(ActorID).

% INVARIANT: Addressing mechanism is opaque
addressing_invariant :-
    forall(
        (actor_exists(ActorID), send_in_scope(ActorID, SendFnID)),
        send_implementation_opaque(ActorID, SendFnID)
    ).

% ============================================================================
% 9. MESSAGE AND RESPONSE TYPES
% ============================================================================

% Message has required fields
is_message(Message) :-
    has_field(Message, id),
    has_field(Message, type),
    has_field(Message, payload).

% Response has required fields
is_response(Response) :-
    has_field(Response, success).

% Send returns response
send_returns(SendFnID, Response) :-
    send_function(SendFnID),
    is_response(Response).

% ============================================================================
% 10. VERIFICATION QUERIES
% ============================================================================

% Query: Verify all actors are pure functions
% ?- pure_function_invariant.

% Query: Verify all actors have send injected
% ?- send_injection_invariant.

% Query: Verify send is the only primitive
% ?- send_primitive_invariant.

% Query: Verify systems provide send
% ?- system_send_invariant.

% Query: Verify bridge API usage
% ?- bridge_invariant.

% Query: Verify uniform composition
% ?- composition_invariant.

% Query: Verify addressing opacity
% ?- addressing_invariant.

% Query: Find actors with send in scope
% ?- send_in_scope(ActorID, SendFnID).

% Query: Find systems that are actors
% ?- system_is_actor(SystemID).

% Query: Find nested systems
% ?- uniform_composition(ParentID, ChildID).

% Query: Find bridge calls
% ?- is_bridge_call(CallerID, ActorID, Message).

% Query: Find internal calls
% ?- is_internal_call(ActorID, TargetID, Message).

% ============================================================================
% 11. EXAMPLE FACTS (for testing)
% ============================================================================

% External code
is_external_code("user-code").

% Systems
actor_exists("system").
is_system("system").

actor_exists("subsystem").
is_system("subsystem").

% Actors
actor_exists("task-1").
actor_exists("task-2").

% Factories
actor_factory("TaskActorFactory").

% Send functions
send_function("system.send").
send_function("subsystem.send").

% System provides send
implements("system", "system.send").
implements("subsystem", "subsystem.send").

% Actors created with dependencies
has_dependencies("task-1", ["task-1-data", "system.send"]).
has_dependencies("task-2", ["task-2-data", "system.send"]).

% Registration
registered_in("task-1", "system").
registered_in("task-2", "system").
registered_in("subsystem", "system").

% Messages
is_message(msg1).
is_message(msg2).

% Calls
calls_method("user-code", "task-1", send, msg1).
calls_function("task-1", "system.send", "task-2", msg2).

% ============================================================================
% 12. COMPLETENESS CHECKS
% ============================================================================

% Check: All invariants hold
all_invariants_hold :-
    pure_function_invariant,
    send_injection_invariant,
    send_primitive_invariant,
    system_send_invariant,
    bridge_invariant,
    composition_invariant,
    addressing_invariant.

% Check: System is well-formed
system_well_formed(SystemID) :-
    system_exists(SystemID),
    system_is_actor(SystemID),
    system_has_registry(SystemID),
    system_provides_send(SystemID, _).

% Check: Actor is well-formed
actor_well_formed(ActorID) :-
    actor_exists(ActorID),
    is_pure_function(ActorID),
    send_in_scope(ActorID, _),
    has_method(ActorID, send).

% ============================================================================
% END
% ============================================================================
