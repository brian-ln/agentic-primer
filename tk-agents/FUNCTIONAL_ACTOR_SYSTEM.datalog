% ============================================================================
% Functional Actor System - Datalog Facts and Rules
% ============================================================================
% Formal specification of the functional actor model where:
% - Actors are JUST functions: (Message) => Promise<Response>
% - System is JUST a function wrapping a Map
% - Everything is uniform - no special types

% ============================================================================
% 1. STRUCTURAL PROPERTIES (Functional Model)
% ============================================================================

% actor_function(ID) - An actor function exists
actor_function(ActorID) :- actor_exists(ActorID).

% Actor is defined by a function signature
% Every actor has the same type: (Message) => Promise<Response>
has_uniform_type(ActorID) :- actor_function(ActorID).

% System is also just an actor function
system_is_actor(SystemID) :- is_system(SystemID), actor_function(SystemID).

% No inheritance, no classes - just functions
no_inheritance(ActorID) :- actor_function(ActorID).

% Actors have closure state (private)
has_closure_state(ActorID) :- actor_function(ActorID), has_private_state(ActorID).

% System wraps a Map in closure
system_wraps_map(SystemID) :- is_system(SystemID), has_closure_state(SystemID).

% ============================================================================
% 2. MESSAGE-BASED OPERATIONS
% ============================================================================

% All operations happen via messages (even registration)
operation_via_message(Op) :- operation_type(Op).

operation_type("register").
operation_type("unregister").
operation_type("route").
operation_type("list").
operation_type("ping").

% message(ID, Type, Payload, Sender)
message(MsgID, Type, Payload, Sender) :-
    message_exists(MsgID),
    message_type(MsgID, Type),
    message_payload(MsgID, Payload),
    message_sender(MsgID, Sender).

% Registration happens via message to System
registers_via_message(ActorID, SystemID) :-
    actor_function(ActorID),
    is_system(SystemID),
    sent_message(ActorID, SystemID, "register").

% ============================================================================
% 3. UNIFORM COMPOSITION
% ============================================================================

% All actors have the same interface
same_interface(Actor1, Actor2) :-
    actor_function(Actor1),
    actor_function(Actor2).

% System has same interface as any actor
system_same_interface(SystemID, ActorID) :-
    is_system(SystemID),
    actor_function(ActorID),
    same_interface(SystemID, ActorID).

% Systems can contain systems (uniform composition)
system_contains_system(ParentSystemID, ChildSystemID) :-
    is_system(ParentSystemID),
    is_system(ChildSystemID),
    registered_in(ChildSystemID, ParentSystemID).

% Nested systems form trees
system_tree_depth(SystemID, 0) :- is_system(SystemID), \+ registered_in(SystemID, _).
system_tree_depth(SystemID, Depth) :-
    is_system(SystemID),
    registered_in(SystemID, ParentSystemID),
    system_tree_depth(ParentSystemID, ParentDepth),
    Depth is ParentDepth + 1.

% ============================================================================
% 4. CLOSURE-BASED STATE
% ============================================================================

% Actors capture state in closures (not instance variables)
has_closure_state(ActorID) :- captures_state(ActorID).

% System captures Map in closure
system_captures_map(SystemID) :-
    is_system(SystemID),
    has_closure_state(SystemID).

% State is private (not accessible externally)
state_is_private(ActorID) :-
    has_closure_state(ActorID),
    \+ has_public_state_access(ActorID).

% Actors capture dependencies in closures
captures_dependency(ActorID, DepID) :-
    actor_function(ActorID),
    depends_on(ActorID, DepID),
    closure_captures(ActorID, DepID).

% Example: Coordinator captures System in closure
coordinator_captures_system(CoordID, SystemID) :-
    is_coordinator(CoordID),
    is_system(SystemID),
    captures_dependency(CoordID, SystemID).

% ============================================================================
% 5. FUNCTION COMPOSITION
% ============================================================================

% Higher-order functions wrap actors
wrapped_by(ActorID, WrapperID) :-
    actor_function(ActorID),
    higher_order_function(WrapperID),
    wraps(WrapperID, ActorID).

% Common wrappers
higher_order_function("withLogging").
higher_order_function("withRetry").
higher_order_function("withTimeout").
higher_order_function("withMetrics").

% Composition chains
composition_chain(ActorID, [ActorID]) :- actor_function(ActorID), \+ wrapped_by(ActorID, _).
composition_chain(ActorID, [WrapperID | Rest]) :-
    wrapped_by(ActorID, WrapperID),
    composition_chain(ActorID, Rest).

% Composability property
is_composable(ActorID) :- actor_function(ActorID).

% ============================================================================
% 6. DIRECT INVOCATION
% ============================================================================

% Actors can be called directly (without system)
can_call_directly(ActorID) :- actor_function(ActorID).

% System routing is optional
routing_is_optional(ActorID) :- can_call_directly(ActorID).

% Direct call semantics
direct_call(CallerID, ActorID, Message) :-
    actor_function(CallerID),
    actor_function(ActorID),
    invokes_directly(CallerID, ActorID, Message).

% Via system call semantics
system_call(CallerID, SystemID, ActorID, Message) :-
    actor_function(CallerID),
    is_system(SystemID),
    actor_function(ActorID),
    sends_route_message(CallerID, SystemID, ActorID, Message).

% ============================================================================
% 7. REGISTRATION MODEL
% ============================================================================

% Registration is explicit (via message)
registered_in(ActorID, SystemID) :-
    actor_function(ActorID),
    is_system(SystemID),
    registration_message_sent(ActorID, SystemID).

% Registration message structure
registration_message_sent(ActorID, SystemID) :-
    message(MsgID, "register", Payload, _),
    message_target(MsgID, SystemID),
    registration_payload(Payload, ActorID, _).

registration_payload(Payload, ActorID, ActorFn) :-
    payload_has_field(Payload, "id", ActorID),
    payload_has_field(Payload, "actor", ActorFn).

% Actors can register with multiple systems
registered_in_multiple(ActorID, System1, System2) :-
    registered_in(ActorID, System1),
    registered_in(ActorID, System2),
    System1 \= System2.

% Shared actors (registered in multiple systems)
is_shared_actor(ActorID) :-
    registered_in(ActorID, System1),
    registered_in(ActorID, System2),
    System1 \= System2.

% ============================================================================
% 8. BEHAVIORAL INVARIANTS (Functional Model)
% ============================================================================

% Invariant: All actors have uniform interface
uniform_interface_invariant :-
    \+ (actor_function(A1), actor_function(A2), \+ same_interface(A1, A2)).

% Invariant: System is an actor
system_is_actor_invariant :-
    forall(is_system(S), actor_function(S)).

% Invariant: State is always private
state_privacy_invariant :-
    \+ (has_closure_state(ActorID), has_public_state_access(ActorID)).

% Invariant: Registration happens via messages
registration_via_message_invariant :-
    forall(registered_in(ActorID, SystemID),
           registration_message_sent(ActorID, SystemID)).

% Invariant: Systems can nest infinitely
nested_systems_allowed(ParentID, ChildID) :-
    is_system(ParentID),
    is_system(ChildID),
    registered_in(ChildID, ParentID).

% Invariant: No cycles in system nesting
system_nesting_acyclic :-
    \+ (is_system(S), system_contains_transitively(S, S)).

system_contains_transitively(Parent, Child) :-
    system_contains_system(Parent, Child).
system_contains_transitively(Parent, Child) :-
    system_contains_system(Parent, Intermediate),
    system_contains_transitively(Intermediate, Child).

% Invariant: Actors are composable
actor_composition_invariant :-
    forall(actor_function(ActorID), is_composable(ActorID)).

% ============================================================================
% 9. PROXY-BASED METAPROGRAMMING (method_missing pattern)
% ============================================================================

% Actors can be wrapped with Proxy for dynamic method dispatch
has_proxy_wrapper(ActorID) :- actor_function(ActorID), wrapped_with_proxy(ActorID).

% Proxy intercepts property access
proxy_intercepts(ActorID, MethodName) :-
    has_proxy_wrapper(ActorID),
    method_accessed(ActorID, MethodName).

% Two behaviors: defined methods vs dynamic methods
defined_method(ActorID, MethodName) :-
    has_proxy_wrapper(ActorID),
    method_exists_on_function(ActorID, MethodName).

dynamic_method(ActorID, MethodName) :-
    has_proxy_wrapper(ActorID),
    \+ method_exists_on_function(ActorID, MethodName),
    method_accessed(ActorID, MethodName).

% Dispatch priority: defined methods take precedence
method_dispatch_priority(ActorID, MethodName, "defined") :-
    defined_method(ActorID, MethodName).

method_dispatch_priority(ActorID, MethodName, "dynamic") :-
    dynamic_method(ActorID, MethodName).

% Dynamic method converts to message
dynamic_method_creates_message(ActorID, MethodName, MessageType) :-
    dynamic_method(ActorID, MethodName),
    MessageType = MethodName.  % Method name becomes message type

% Method arguments become message payload
method_args_to_payload(ActorID, MethodName, Args, Payload) :-
    dynamic_method(ActorID, MethodName),
    method_invoked_with_args(ActorID, MethodName, Args),
    (single_arg(Args) -> Payload = Args ; Payload = Args).

% Proxy behavior is like Smalltalk's doesNotUnderstand:
smalltalk_like_behavior(ActorID) :- has_proxy_wrapper(ActorID).

% Ruby method_missing equivalent
ruby_method_missing_equivalent(ActorID) :- has_proxy_wrapper(ActorID).

% Any method name is valid (no compilation errors)
any_method_valid(ActorID, MethodName) :- has_proxy_wrapper(ActorID).

% Proxy preserves function call behavior
proxy_preserves_function_call(ActorID) :-
    has_proxy_wrapper(ActorID),
    can_call_as_function(ActorID).

% Dual interface: function call OR method call
dual_interface(ActorID) :-
    has_proxy_wrapper(ActorID),
    can_call_as_function(ActorID),
    can_call_as_method(ActorID).

% ============================================================================
% 10. FUNCTIONAL PROPERTIES
% ============================================================================

% Pure function property (no side effects beyond returned Response)
is_pure_function(ActorID) :-
    actor_function(ActorID),
    deterministic_actor(ActorID),
    no_external_side_effects(ActorID).

% Referential transparency for deterministic actors
referentially_transparent(ActorID) :-
    is_pure_function(ActorID).

% Closure captures immutable values
closure_captures_immutable(ActorID, Value) :-
    captures_state(ActorID),
    closure_value(ActorID, Value),
    immutable_value(Value).

% Function composition is associative
composition_associative(F, G, H) :-
    higher_order_function(F),
    higher_order_function(G),
    higher_order_function(H).

% ============================================================================
% 10. COMPARISON WITH CLASS-BASED MODEL
% ============================================================================

% Functional model has no classes
no_classes(ActorID) :- actor_function(ActorID).

% Functional model has no inheritance
no_inheritance_hierarchy :- forall(actor_function(_), no_inheritance(_)).

% Functional model uses closures instead of private fields
uses_closures_not_fields(ActorID) :-
    actor_function(ActorID),
    has_closure_state(ActorID),
    \+ has_private_fields(ActorID).

% Single-phase initialization (no setSystem)
single_phase_init(ActorID) :-
    actor_function(ActorID),
    \+ requires_two_phase_init(ActorID).

% No circular dependency problem
no_circular_dependency(ActorID, SystemID) :-
    actor_function(ActorID),
    is_system(SystemID),
    captures_dependency(ActorID, SystemID).

% ============================================================================
% 11. EXAMPLE FACTS (Functional Model)
% ============================================================================

% Actor functions
actor_exists("system").
actor_exists("echo-1").
actor_exists("coordinator").
actor_exists("worker-1").
actor_exists("worker-2").

% System identification
is_system("system").

% Closure state
has_private_state("system").
has_private_state("echo-1").
has_private_state("coordinator").
has_private_state("worker-1").
has_private_state("worker-2").

% Registration relationships
registered_in("echo-1", "system").
registered_in("coordinator", "system").
registered_in("worker-1", "system").
registered_in("worker-2", "system").

% Coordinator captures System in closure
is_coordinator("coordinator").
depends_on("coordinator", "system").
closure_captures("coordinator", "system").

% Deterministic actors (pure functions)
deterministic_actor("echo-1").
deterministic_actor("worker-1").
deterministic_actor("worker-2").

% No external side effects
no_external_side_effects("echo-1").
no_external_side_effects("worker-1").
no_external_side_effects("worker-2").

% Composition examples
wraps("withLogging", "system").
wraps("withRetry", "echo-1").

% Shared actor example
registered_in("shared-actor", "system-1").
registered_in("shared-actor", "system-2").

% Message examples
message_exists("reg-1").
message_type("reg-1", "register").
message_target("reg-1", "system").
payload_has_field(payload_1, "id", "echo-1").
payload_has_field(payload_1, "actor", echo_fn_1).
message_payload("reg-1", payload_1).

% Proxy wrapper examples
wrapped_with_proxy("system").
wrapped_with_proxy("echo-1").
wrapped_with_proxy("coordinator").

% Defined methods (explicitly attached to function)
method_exists_on_function("system", "specialPing").
method_exists_on_function("echo-1", "customEcho").

% Method access examples
method_accessed("system", "ping").           % Dynamic (converts to message)
method_accessed("system", "specialPing").    % Defined (uses actual method)
method_accessed("echo-1", "sayHello").       % Dynamic
method_accessed("echo-1", "customEcho").     % Defined

% Dual interface examples
can_call_as_function("system").
can_call_as_function("echo-1").
can_call_as_method("system").
can_call_as_method("echo-1").

% ============================================================================
% 12. QUERIES (Functional Model)
% ============================================================================

% Query: Verify system is an actor
% ?- system_is_actor("system").

% Query: Find all actors with closure state
% ?- has_closure_state(ActorID).

% Query: Find shared actors (registered in multiple systems)
% ?- is_shared_actor(ActorID).

% Query: Find composition chains
% ?- composition_chain("echo-1", Chain).

% Query: Verify no circular dependencies
% ?- no_circular_dependency(ActorID, SystemID).

% Query: Find all pure functions
% ?- is_pure_function(ActorID).

% Query: Verify uniform interface invariant
% ?- uniform_interface_invariant.

% Query: Find nested systems
% ?- system_contains_system(ParentID, ChildID).

% Query: Find actors that can be called directly
% ?- can_call_directly(ActorID).

% Query: Compare with class-based model
% ?- no_classes(ActorID), single_phase_init(ActorID).

% Query: Find actors with Proxy wrapper
% ?- has_proxy_wrapper(ActorID).

% Query: Check if method is defined or dynamic
% ?- defined_method("system", "specialPing").
% ?- dynamic_method("system", "ping").

% Query: Find method dispatch priority
% ?- method_dispatch_priority("system", MethodName, Priority).

% Query: Verify Smalltalk-like behavior
% ?- smalltalk_like_behavior(ActorID).

% Query: Find actors with dual interface (function + methods)
% ?- dual_interface(ActorID).

% Query: Show all dynamic methods
% ?- dynamic_method(ActorID, MethodName).

% Query: Show all defined methods
% ?- defined_method(ActorID, MethodName).

% ============================================================================
% END
% ============================================================================
