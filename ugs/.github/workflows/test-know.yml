name: Session Knowledge System Tests

# Epic: agentic-primer-t49.5
# Runs comprehensive test suite for know tool

on:
  push:
    branches:
      - main
      - session-knowledge-*
    paths:
      - 'src/session-knowledge/**'
      - 'src/entities/**'
      - 'src/graph.ts'
      - 'src/context.ts'
      - 'scripts/test-*.sh'
      - '.github/workflows/test-know.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'src/session-knowledge/**'
      - 'src/entities/**'
      - 'src/graph.ts'
      - 'src/context.ts'
  workflow_dispatch:
    inputs:
      coverage:
        description: 'Generate coverage report'
        required: false
        default: 'true'
      fast:
        description: 'Fast mode (skip slow tests)'
        required: false
        default: 'false'

env:
  BUN_VERSION: '1.2.20'

jobs:
  test:
    name: Run Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Verify Bun installation
        run: |
          bun --version
          echo "✓ Bun installed successfully"

      - name: Install dependencies
        run: |
          bun install --frozen-lockfile
          echo "✓ Dependencies installed"

      - name: Create test directories
        run: |
          mkdir -p ~/.claude/index
          mkdir -p .coverage
          mkdir -p test-results
          echo "✓ Directories created"

      - name: Check database
        id: check-db
        run: |
          if [[ -f ~/.claude/index/sessions-libsql.db ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✓ Database found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠ Database not found (tests may fail)"
          fi

      - name: Build index (if needed)
        if: steps.check-db.outputs.exists == 'false'
        run: |
          # Create minimal test database
          # Note: In real CI, you'd restore from cache or build from fixtures
          echo "⚠ Creating minimal test database"
          # TODO: Add database fixture or build script

      - name: Run test suite
        id: test
        run: |
          # Determine flags
          FLAGS="--ci"

          if [[ "${{ github.event.inputs.coverage }}" == "true" ]] || [[ -z "${{ github.event.inputs.coverage }}" ]]; then
            FLAGS="$FLAGS --coverage"
          fi

          if [[ "${{ github.event.inputs.fast }}" == "true" ]]; then
            FLAGS="$FLAGS --fast"
          fi

          # Run tests
          echo "Running: ./scripts/test-all.sh $FLAGS"
          ./scripts/test-all.sh $FLAGS

      - name: Parse test results
        if: always()
        id: results
        run: |
          # Extract results from test-all.sh JSON output
          if [[ -f test-results/summary.json ]]; then
            SUITES_RUN=$(jq -r '.suites_run' test-results/summary.json)
            SUITES_PASSED=$(jq -r '.suites_passed' test-results/summary.json)
            SUITES_FAILED=$(jq -r '.suites_failed' test-results/summary.json)

            echo "suites_run=$SUITES_RUN" >> $GITHUB_OUTPUT
            echo "suites_passed=$SUITES_PASSED" >> $GITHUB_OUTPUT
            echo "suites_failed=$SUITES_FAILED" >> $GITHUB_OUTPUT

            echo "Test Results:"
            echo "  Suites run: $SUITES_RUN"
            echo "  Suites passed: $SUITES_PASSED"
            echo "  Suites failed: $SUITES_FAILED"
          else
            echo "⚠ No test results found"
          fi

      - name: Upload coverage report
        if: always() && (github.event.inputs.coverage == 'true' || github.event.inputs.coverage == '')
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: .coverage/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 30

      - name: Comment coverage on PR
        if: always() && github.event_name == 'pull_request' && hashFiles('.coverage/lcov.info') != ''
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: .coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}
          delete-old-comments: true

      - name: Check coverage thresholds
        if: always()
        run: |
          if [[ -f .coverage/lcov.info ]]; then
            echo "Checking coverage thresholds..."

            # Simple coverage check (in production, use a proper tool)
            LINES_HIT=$(grep -c "^DA:.*,1$" .coverage/lcov.info || echo "0")
            LINES_FOUND=$(grep -c "^DA:" .coverage/lcov.info || echo "1")

            if [[ $LINES_FOUND -gt 0 ]]; then
              COVERAGE_PERCENT=$((LINES_HIT * 100 / LINES_FOUND))
              echo "Line coverage: ${COVERAGE_PERCENT}%"

              # Threshold: 70%
              if [[ $COVERAGE_PERCENT -lt 70 ]]; then
                echo "::warning::Coverage below threshold (70%): ${COVERAGE_PERCENT}%"
                exit 1
              else
                echo "✓ Coverage meets threshold: ${COVERAGE_PERCENT}%"
              fi
            fi
          else
            echo "⚠ No coverage data found"
          fi

      - name: Generate test summary
        if: always()
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.test.outcome }}" == "success" ]]; then
            echo "✅ **All tests passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some tests failed**" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Bun Version:** ${{ env.BUN_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner:** ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref:** ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

          if [[ -n "${{ steps.results.outputs.suites_run }}" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Suites run: ${{ steps.results.outputs.suites_run }}" >> $GITHUB_STEP_SUMMARY
            echo "- Suites passed: ✅ ${{ steps.results.outputs.suites_passed }}" >> $GITHUB_STEP_SUMMARY
            echo "- Suites failed: ❌ ${{ steps.results.outputs.suites_failed }}" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -f .coverage/coverage.txt ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Coverage" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat .coverage/coverage.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: |
          # Check TypeScript types
          bun run tsc --noEmit || {
            echo "::warning::TypeScript type checking failed"
            exit 0  # Don't fail the build for type errors (warning only)
          }

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments..."
          grep -r "TODO\|FIXME" src/session-knowledge/ || echo "✓ No TODOs found"

  integration:
    name: Integration Test (Real Database)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Create directories
        run: |
          mkdir -p ~/.claude/index
          mkdir -p ~/.claude/projects/test-project

      - name: Build real index
        run: |
          # In a real CI, you'd:
          # 1. Restore session fixtures from cache/artifacts
          # 2. Build index from fixtures
          # 3. Run integration tests
          echo "⚠ Integration test requires real session data"
          echo "TODO: Add session fixtures and build process"

      - name: Run cognitive integration tests
        run: |
          bun test src/session-knowledge/__tests__/cognitive-integration.test.ts

      - name: Validate performance
        run: |
          echo "Checking performance benchmarks..."
          # Run tests and check timing
          # TODO: Add performance assertions

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security audit
        run: |
          # Check for known vulnerabilities
          if command -v bun &> /dev/null; then
            bun audit || echo "⚠ No audit command available"
          fi

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [test, lint, integration, security]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.test.result }}" == "success" ]] && \
             [[ "${{ needs.lint.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "✅ All checks passed"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "❌ Some checks failed"
          fi

      # Add notification step here (Slack, Discord, etc.)
      # Example:
      # - name: Notify Slack
      #   if: always()
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "status": "${{ steps.status.outputs.status }}",
      #         "ref": "${{ github.ref }}",
      #         "sha": "${{ github.sha }}"
      #       }
