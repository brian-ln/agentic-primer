# Bootstrap System Architecture

## Overview

This document defines the concrete architecture for a self-bootstrapping, self-optimizing repository automation system.

## Core Principle

**A bootstrap is not a prompt - it's a system with three components:**

1. **Seed** - The minimal input (what you give to an agent)
2. **Executor** - The mechanism that interprets and executes the seed
3. **Validator** - The process that verifies execution and enables improvement

## System Components

### 1. The Seed Layer

**File: `BOOTSTRAP_SEED.md`**

This is the actual prompt given to agents. It should be:
- Under 500 words (fits in context with other instructions)
- Agent-agnostic (no references to specific tools)
- Imperative (clear actions, not descriptions)
- Verifiable (includes success criteria)

```markdown
# Bootstrap Seed v1.0

Build a git-native issue automation system. Create these files:

## Workflows
`.github/workflows/issue-router.yml`
- Triggers on issue open/label
- Routes to appropriate agent based on label
- Creates PR with changes

## Templates
`.github/ISSUE_TEMPLATE/task.yml`
- Fields: title, description, acceptance_criteria
- Auto-labels based on content

## Knowledge Base
`docs/knowledge/README.md`
- Structure for patterns/decisions/insights
- How to contribute

## Verification
`scripts/verify-bootstrap.sh`
- Checks all files exist
- Validates YAML syntax
- Returns exit code 0 if pass

Success: All files created, verify script passes.
```

**Key insight**: The seed references specific file paths and validation criteria, not abstract concepts.

### 2. The Executor Layer

**File: `EXECUTOR_GUIDE.md`**

This explains HOW to execute the seed with different agents. It's metadata about the bootstrap, not part of the bootstrap itself.

```markdown
# How to Execute Bootstrap

## With GitHub Copilot
1. Create issue with BOOTSTRAP_SEED.md content
2. Assign to @copilot-swe-agent

## With Claude Code
1. Create issue with BOOTSTRAP_SEED.md content
2. Mention @claude in comment

## With Gemini CLI
1. Create issue with BOOTSTRAP_SEED.md content
2. Mention @gemini-cli in comment

## With Aider (local)
cat BOOTSTRAP_SEED.md | aider --yes

## Result
All methods should produce identical file structure.
Can verify with: ./scripts/verify-bootstrap.sh
```

### 3. The Validator Layer

**File: `scripts/verify-bootstrap.sh`**

This is executable code that programmatically checks if bootstrap succeeded.

```bash
#!/bin/bash
set -e

echo "Verifying bootstrap..."

# Required files
REQUIRED=(
  ".github/workflows/issue-router.yml"
  ".github/ISSUE_TEMPLATE/task.yml"
  "docs/knowledge/README.md"
  "scripts/verify-bootstrap.sh"
)

# Check existence
for file in "${REQUIRED[@]}"; do
  if [[ ! -f "$file" ]]; then
    echo "FAIL: Missing $file"
    exit 1
  fi
done

# Validate YAML syntax
for yaml in .github/**/*.yml .github/**/*.yaml; do
  if [[ -f "$yaml" ]]; then
    yamllint "$yaml" || exit 1
  fi
done

# Check workflows have required fields
grep -q "on:" .github/workflows/issue-router.yml || exit 1
grep -q "jobs:" .github/workflows/issue-router.yml || exit 1

# Check templates have required fields
grep -q "name:" .github/ISSUE_TEMPLATE/task.yml || exit 1
grep -q "body:" .github/ISSUE_TEMPLATE/task.yml || exit 1

echo "Bootstrap verification PASSED"
exit 0
```

### 4. The Optimization Layer

**File: `OPTIMIZATION_LOG.md`**

This captures the evolution of the seed over time.

```markdown
# Bootstrap Optimization Log

## v1.0 → v1.1 (2026-01-05)

**Execution**: GitHub Copilot
**Result**: FAIL - Missing verify script

**Issue**: Seed said "create verify script" but didn't specify what it should check
**Fix**: Added explicit verification criteria to seed
**Changed**:
- Before: "Create verify script"
- After: "Create scripts/verify-bootstrap.sh that checks: ..."

**Re-execution**: PASS
**Commit**: abc123

---

## v1.1 → v1.2 (2026-01-06)

**Execution**: Claude Code
**Result**: PASS but incomplete - Workflow missing permissions

**Issue**: Generated workflow failed in GitHub Actions (no write permission)
**Fix**: Added explicit permission requirements to seed
**Changed**:
- Added: "Workflows must include: permissions: contents: write, pull-requests: write"

**Re-execution**: PASS
**Commit**: def456

---
```

## File Organization

```
agentic-primer/
├── BOOTLOADER.md           # User-facing: How to use the system
├── BOOTSTRAP_SEED.md       # The actual prompt (versioned)
├── EXECUTOR_GUIDE.md       # How to run with different agents
├── OPTIMIZATION_LOG.md     # History of improvements
├── ANALYSIS.md             # Deep thinking about approach
├── ARCHITECTURE.md         # This file
│
├── .github/
│   ├── workflows/
│   │   └── issue-router.yml    # Generated by bootstrap
│   └── ISSUE_TEMPLATE/
│       └── task.yml            # Generated by bootstrap
│
├── docs/
│   └── knowledge/
│       └── README.md           # Generated by bootstrap
│
└── scripts/
    ├── verify-bootstrap.sh     # Generated by bootstrap
    └── run-optimization.sh     # Runs optimization loop
```

## The Optimization Loop

```bash
#!/bin/bash
# scripts/run-optimization.sh

VERSION=$1  # e.g., "1.0"
AGENT=$2    # e.g., "copilot", "claude", "gemini"

echo "Testing Bootstrap v$VERSION with $AGENT"

# 1. Clean slate
git checkout main
git clean -fdx
git reset --hard HEAD

# 2. Execute bootstrap
case $AGENT in
  copilot)
    gh issue create --title "Bootstrap v$VERSION" \
      --body "$(cat BOOTSTRAP_SEED.md)"
    # Assign to copilot, wait for completion
    ;;
  claude)
    # Similar for Claude
    ;;
  aider)
    cat BOOTSTRAP_SEED.md | aider --yes
    ;;
esac

# 3. Verify
if ./scripts/verify-bootstrap.sh; then
  echo "✓ Bootstrap v$VERSION PASSED with $AGENT"

  # 4. Capture results
  git add -A
  git commit -m "Bootstrap v$VERSION via $AGENT - PASS"
  git tag "bootstrap-v$VERSION-$AGENT"

else
  echo "✗ Bootstrap v$VERSION FAILED with $AGENT"

  # 4. Capture failure
  git add -A
  git commit -m "Bootstrap v$VERSION via $AGENT - FAIL"

  # 5. Prompt for analysis
  echo "What went wrong? Update OPTIMIZATION_LOG.md"
  echo "What should change in BOOTSTRAP_SEED.md?"
fi
```

## Incremental Bootstrap Strategy

**Problem**: A single seed may be too complex for agents to execute reliably.

**Solution**: Break into sequential seeds, each builds on previous.

### Multi-Seed Architecture

```
BOOTSTRAP_SEED_L0.md - "Create directory structure and verify script"
    ↓ (verify)
BOOTSTRAP_SEED_L1.md - "Create GitHub workflows"
    ↓ (verify)
BOOTSTRAP_SEED_L2.md - "Create issue templates"
    ↓ (verify)
BOOTSTRAP_SEED_L3.md - "Create knowledge base structure"
    ↓ (verify)
COMPLETE
```

Each seed:
- Assumes previous layer is complete
- Has its own verification criteria
- Can be tested independently
- Can be optimized independently

### Dependency Declaration

**File: `BOOTSTRAP_MANIFEST.yml`**

```yaml
version: "1.0"

layers:
  - id: l0-structure
    seed: BOOTSTRAP_SEED_L0.md
    verify: scripts/verify-l0.sh
    depends_on: []

  - id: l1-workflows
    seed: BOOTSTRAP_SEED_L1.md
    verify: scripts/verify-l1.sh
    depends_on: [l0-structure]

  - id: l2-templates
    seed: BOOTSTRAP_SEED_L2.md
    verify: scripts/verify-l2.sh
    depends_on: [l0-structure]

  - id: l3-knowledge
    seed: BOOTSTRAP_SEED_L3.md
    verify: scripts/verify-l3.sh
    depends_on: [l0-structure]

execution_order:
  - l0-structure
  - l1-workflows  # Can run in parallel with l2, l3
  - l2-templates
  - l3-knowledge
```

This enables:
- Parallel execution where possible
- Clear failure attribution
- Independent optimization
- Progressive complexity

## Self-Hosting the Optimization

**Meta-insight**: The optimization process itself should be automated via the bootstrap system.

Once bootstrap v1.0 creates a working issue automation system:

1. Create issue: "Optimize bootstrap seed based on execution logs"
2. Agent reads OPTIMIZATION_LOG.md
3. Agent proposes changes to BOOTSTRAP_SEED.md
4. Agent creates PR with improved seed
5. Human reviews and merges
6. Next execution uses improved seed

**This closes the loop**: The bootstrapped system improves its own bootstrap.

## Metrics to Track

For each bootstrap execution, capture:

```yaml
execution:
  version: "1.2"
  agent: "claude-code"
  timestamp: "2026-01-05T10:30:00Z"
  duration_seconds: 245

results:
  verification_passed: true
  files_created: 12
  files_expected: 12
  errors: []

quality:
  workflow_valid_yaml: true
  templates_have_required_fields: true
  docs_not_empty: true
  verify_script_executable: true

improvements:
  - "Workflow includes correct permissions"
  - "Templates use consistent naming"

issues:
  - "Generated README too generic"
  - "Verify script doesn't check template validation"
```

## Success Criteria for Complete System

The bootstrap system is "complete" when:

1. **Reliable**: 90%+ success rate across all agents (Copilot, Claude, Gemini, Aider)
2. **Verified**: All executions pass automated verification
3. **Documented**: OPTIMIZATION_LOG shows clear evolution and reasoning
4. **Self-improving**: System can generate optimization suggestions
5. **Portable**: Single command/issue creates working system
6. **Tested**: Has been executed successfully 10+ times across different repos

## Relationship to BOOTLOADER.md

**BOOTLOADER.md** is the user-facing documentation:
- "Here's how to bootstrap a repo using this system"
- Lists agent options (Copilot, Claude, Gemini, Aider)
- Shows one-liner commands
- Targets users who want to USE the bootstrap

**BOOTSTRAP_SEED.md** is the technical payload:
- Actual instructions executed by agents
- Specific file paths and requirements
- Verification criteria
- Targets agents who EXECUTE the bootstrap

**ARCHITECTURE.md** (this file) is the meta-documentation:
- How the bootstrap system itself works
- How to improve the bootstrap
- System design rationale
- Targets maintainers who DEVELOP the bootstrap

## Next Actions

To implement this architecture:

1. **Create BOOTSTRAP_SEED.md v1.0**
   - Start with minimal single-layer seed
   - 10-15 specific instructions
   - Clear success criteria

2. **Create scripts/verify-bootstrap.sh**
   - Check file existence
   - Validate YAML syntax
   - Check required content

3. **Test with ONE agent first**
   - Use Claude Code (since you're in Claude Code now)
   - Create issue with seed
   - Observe execution
   - Document in OPTIMIZATION_LOG.md

4. **Refine based on results**
   - What worked? Keep it.
   - What failed? Fix seed and retry.
   - What was ambiguous? Make explicit.

5. **Once stable, test other agents**
   - Same seed with Copilot
   - Same seed with Gemini
   - Same seed with Aider
   - Document agent-specific quirks

6. **Split into layers if needed**
   - If single seed too complex
   - Create L0, L1, L2, L3
   - Each with own verification

7. **Build optimization automation**
   - scripts/run-optimization.sh
   - Automates test/verify/document cycle

8. **Close the meta-loop**
   - Use bootstrapped system to optimize itself
   - Create issue: "Improve bootstrap seed"
   - System generates PR with improvements

## Conclusion

This architecture provides:
- Clear separation of concerns (seed/executor/validator)
- Systematic optimization process
- Measurable success criteria
- Path to self-improvement

The key insight: **Don't optimize the prompt, optimize the SYSTEM that creates and refines prompts.**
