name: Implementation Automation

on:
  issues:
    types: [opened, labeled, reopened]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  implementation-task:
    if: contains(github.event.issue.labels.*.name, 'implementation')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract issue details
        id: issue-details
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Parse the issue body to extract implementation details
            const description = body.match(/### Description\s*\n\s*(.+?)(?=\n###|\n\n###|$)/s)?.[1]?.trim() || 'Not specified';
            const acceptanceCriteria = body.match(/### Acceptance Criteria\s*\n\s*(.+?)(?=\n###|\n\n###|$)/s)?.[1]?.trim() || 'Not specified';
            const technicalDetails = body.match(/### Technical Details\s*\n\s*(.+?)(?=\n###|\n\n###|$)/s)?.[1]?.trim() || 'Not specified';
            
            core.setOutput('description', description);
            core.setOutput('acceptance_criteria', acceptanceCriteria);
            core.setOutput('technical_details', technicalDetails);
            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_title', issue.title);

      - name: Create implementation branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b implementation/issue-${{ steps.issue-details.outputs.issue_number }}

      - name: Create implementation tracking document
        run: |
          mkdir -p docs/knowledge/implementation
          CURRENT_DATE=$(date +%Y-%m-%d)
          
          cat > docs/knowledge/implementation/issue-${{ steps.issue-details.outputs.issue_number }}.md << EOF
          # Implementation: ${{ steps.issue-details.outputs.issue_title }}

          **Issue:** #${{ steps.issue-details.outputs.issue_number }}  
          **Date:** ${CURRENT_DATE}  
          **Status:** In Progress

          ## Description

          ${{ steps.issue-details.outputs.description }}

          ## Acceptance Criteria

          ${{ steps.issue-details.outputs.acceptance_criteria }}

          ## Technical Details

          ${{ steps.issue-details.outputs.technical_details }}

          ## Implementation Progress

          ### Completed Tasks
          - [x] Created implementation branch
          - [x] Set up tracking document

          ### In Progress
          - [ ] TBD

          ### Pending
          - [ ] TBD

          ## Code Changes

          _Document significant code changes and decisions here_

          ### Files Modified
          - TBD

          ### New Files
          - TBD

          ## Testing

          ### Test Plan
          - [ ] Unit tests
          - [ ] Integration tests
          - [ ] Manual testing

          ### Test Results
          - TBD

          ## Documentation Updates

          - [ ] Code comments
          - [ ] README updates
          - [ ] API documentation

          ## Review Checklist

          - [ ] Code follows project standards
          - [ ] Tests pass
          - [ ] Documentation updated
          - [ ] No security vulnerabilities
          - [ ] Performance considerations addressed

          ## Notes

          _Add any additional notes or observations_

          ---
          *This document was auto-generated by the Implementation Automation workflow*
          EOF

      - name: Commit implementation tracking document
        run: |
          git add docs/knowledge/implementation/
          git commit -m "Implementation: ${{ steps.issue-details.outputs.issue_title }} (#${{ steps.issue-details.outputs.issue_number }})"
          git push origin implementation/issue-${{ steps.issue-details.outputs.issue_number }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Implementation: ${{ steps.issue-details.outputs.issue_title }}`,
              head: `implementation/issue-${{ steps.issue-details.outputs.issue_number }}`,
              base: 'main',
              body: `# Implementation

            This PR implements the changes for issue #${{ steps.issue-details.outputs.issue_number }}.

            ## Description
            ${{ steps.issue-details.outputs.description }}

            ## Acceptance Criteria
            ${{ steps.issue-details.outputs.acceptance_criteria }}

            ## What's Included
            - Implementation tracking document in \`docs/knowledge/implementation/\`
            - Code changes (to be added)

            ## Testing
            - [ ] Unit tests pass
            - [ ] Integration tests pass
            - [ ] Manual testing complete

            ## Review Notes
            Please review the implementation and provide feedback.

            Closes #${{ steps.issue-details.outputs.issue_number }}`
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue-details.outputs.issue_number }},
              body: `ğŸ”¨ **Implementation Automation Started**

            An implementation branch has been created and a pull request has been opened: #${pr.data.number}

            The implementation tracking document is located at: \`docs/knowledge/implementation/issue-${{ steps.issue-details.outputs.issue_number }}.md\`

            Please proceed with the implementation and update the tracking document as you progress.`
            });
