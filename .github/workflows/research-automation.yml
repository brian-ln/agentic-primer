name: Research Automation

on:
  issues:
    types: [opened, labeled, reopened]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  research-task:
    if: contains(github.event.issue.labels.*.name, 'research')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract issue details
        id: issue-details
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Parse the issue body to extract research question and context
            const researchQuestion = body.match(/### Research Question\s*\n\s*(.+?)(?=\n###|\n\n###|$)/s)?.[1]?.trim() || 'Not specified';
            const contextText = body.match(/### Context\s*\n\s*(.+?)(?=\n###|\n\n###|$)/s)?.[1]?.trim() || 'Not specified';
            const scope = body.match(/### Scope\s*\n\s*(.+?)(?=\n###|\n\n###|$)/s)?.[1]?.trim() || 'Not specified';
            
            core.setOutput('research_question', researchQuestion);
            core.setOutput('context', contextText);
            core.setOutput('scope', scope);
            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_title', issue.title);

      - name: Create research branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b research/issue-${{ steps.issue-details.outputs.issue_number }}

      - name: Create research document
        run: |
          mkdir -p docs/knowledge/research
          
          cat > docs/knowledge/research/issue-${{ steps.issue-details.outputs.issue_number }}.md << 'EOF'
          # Research: ${{ steps.issue-details.outputs.issue_title }}

          **Issue:** #${{ steps.issue-details.outputs.issue_number }}  
          **Date:** $(date +%Y-%m-%d)  
          **Status:** In Progress

          ## Research Question

          ${{ steps.issue-details.outputs.research_question }}

          ## Context

          ${{ steps.issue-details.outputs.context }}

          ## Scope

          ${{ steps.issue-details.outputs.scope }}

          ## Methodology

          1. Literature review
          2. Best practices analysis
          3. Comparative analysis
          4. Documentation review

          ## Findings

          _This section will be populated by automated research processes or manual investigation._

          ### Key Insights

          - TBD

          ### Related Technologies/Approaches

          - TBD

          ### Best Practices

          - TBD

          ## Recommendations

          _Based on the research findings, the following recommendations are made:_

          - TBD

          ## References

          - Issue #${{ steps.issue-details.outputs.issue_number }}

          ## Next Steps

          - [ ] Review findings
          - [ ] Validate recommendations
          - [ ] Create planning issue if needed

          ---
          *This document was auto-generated by the Research Automation workflow*
          EOF

      - name: Commit research document
        run: |
          git add docs/knowledge/research/
          git commit -m "Research: ${{ steps.issue-details.outputs.issue_title }} (#${{ steps.issue-details.outputs.issue_number }})"
          git push origin research/issue-${{ steps.issue-details.outputs.issue_number }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Research: ${{ steps.issue-details.outputs.issue_title }}`,
              head: `research/issue-${{ steps.issue-details.outputs.issue_number }}`,
              base: 'main',
              body: `# Research Document

            This PR contains the research document for issue #${{ steps.issue-details.outputs.issue_number }}.

            ## Research Question
            ${{ steps.issue-details.outputs.research_question }}

            ## What's Included
            - Research document template in \`docs/knowledge/research/\`
            - Initial structure for findings and recommendations

            ## Next Steps
            1. Review and enhance the research findings
            2. Add references and sources
            3. Complete recommendations section
            4. Merge when research is complete

            Closes #${{ steps.issue-details.outputs.issue_number }}`
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue-details.outputs.issue_number }},
              body: `ğŸ”¬ **Research Automation Started**

            A research document has been created and a pull request has been opened: #${pr.data.number}

            The research document is located at: \`docs/knowledge/research/issue-${{ steps.issue-details.outputs.issue_number }}.md\`

            Please review and enhance the findings, then merge the PR when complete.`
            });
