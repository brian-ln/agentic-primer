name: Planning Automation

on:
  issues:
    types: [opened, labeled, reopened]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  planning-task:
    if: contains(github.event.issue.labels.*.name, 'planning')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract issue details
        id: issue-details
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Parse the issue body to extract planning details
            const objective = body.match(/### Objective\s*\n\s*(.+?)(?=\n###|\n\n###|$)/s)?.[1]?.trim() || 'Not specified';
            const requirements = body.match(/### Requirements\s*\n\s*(.+?)(?=\n###|\n\n###|$)/s)?.[1]?.trim() || 'Not specified';
            const contextText = body.match(/### Context\s*\n\s*(.+?)(?=\n###|\n\n###|$)/s)?.[1]?.trim() || 'Not specified';
            
            core.setOutput('objective', objective);
            core.setOutput('requirements', requirements);
            core.setOutput('context', contextText);
            core.setOutput('issue_number', issue.number);
            core.setOutput('issue_title', issue.title);

      - name: Create planning branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b planning/issue-${{ steps.issue-details.outputs.issue_number }}

      - name: Create planning document
        run: |
          mkdir -p docs/knowledge/planning
          
          cat > docs/knowledge/planning/issue-${{ steps.issue-details.outputs.issue_number }}.md << 'EOF'
          # Planning: ${{ steps.issue-details.outputs.issue_title }}

          **Issue:** #${{ steps.issue-details.outputs.issue_number }}  
          **Date:** $(date +%Y-%m-%d)  
          **Status:** In Progress

          ## Objective

          ${{ steps.issue-details.outputs.objective }}

          ## Requirements

          ${{ steps.issue-details.outputs.requirements }}

          ## Context

          ${{ steps.issue-details.outputs.context }}

          ## Architecture Overview

          _High-level architecture and design decisions_

          ### Components

          - TBD

          ### Data Flow

          - TBD

          ### Technology Choices

          - TBD

          ## Implementation Plan

          ### Phase 1: Foundation
          - [ ] Task 1
          - [ ] Task 2

          ### Phase 2: Core Features
          - [ ] Task 1
          - [ ] Task 2

          ### Phase 3: Polish
          - [ ] Task 1
          - [ ] Task 2

          ## Task Breakdown

          | Task | Description | Estimated Effort | Priority | Dependencies |
          |------|-------------|------------------|----------|--------------|
          | TBD  | TBD         | TBD              | TBD      | TBD          |

          ## Timeline

          - **Phase 1:** TBD
          - **Phase 2:** TBD
          - **Phase 3:** TBD

          ## Risk Assessment

          | Risk | Impact | Likelihood | Mitigation |
          |------|--------|------------|------------|
          | TBD  | TBD    | TBD        | TBD        |

          ## Success Criteria

          - [ ] Criterion 1
          - [ ] Criterion 2
          - [ ] Criterion 3

          ## Next Steps

          1. Review and refine the plan
          2. Create implementation issues
          3. Begin execution

          ---
          *This document was auto-generated by the Planning Automation workflow*
          EOF

      - name: Commit planning document
        run: |
          git add docs/knowledge/planning/
          git commit -m "Planning: ${{ steps.issue-details.outputs.issue_title }} (#${{ steps.issue-details.outputs.issue_number }})"
          git push origin planning/issue-${{ steps.issue-details.outputs.issue_number }}

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Planning: ${{ steps.issue-details.outputs.issue_title }}`,
              head: `planning/issue-${{ steps.issue-details.outputs.issue_number }}`,
              base: 'main',
              body: `# Planning Document

            This PR contains the planning document for issue #${{ steps.issue-details.outputs.issue_number }}.

            ## Objective
            ${{ steps.issue-details.outputs.objective }}

            ## What's Included
            - Planning document template in \`docs/knowledge/planning/\`
            - Architecture overview section
            - Implementation plan with phases
            - Task breakdown structure
            - Timeline and milestones

            ## Next Steps
            1. Review and refine the architecture
            2. Complete task breakdown
            3. Create implementation issues
            4. Merge when planning is complete

            Closes #${{ steps.issue-details.outputs.issue_number }}`
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.issue-details.outputs.issue_number }},
              body: `ğŸ“‹ **Planning Automation Started**

            A planning document has been created and a pull request has been opened: #${pr.data.number}

            The planning document is located at: \`docs/knowledge/planning/issue-${{ steps.issue-details.outputs.issue_number }}.md\`

            Please review and enhance the plan, then merge the PR when complete.`
            });
