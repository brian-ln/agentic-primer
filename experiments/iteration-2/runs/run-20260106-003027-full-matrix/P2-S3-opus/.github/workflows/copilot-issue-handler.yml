name: Copilot Issue Handler

on:
  issues:
    types: [opened, labeled, assigned]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  COPILOT_LABEL: copilot
  AI_TASK_LABEL: ai-task

jobs:
  check-trigger:
    runs-on: ubuntu-latest
    outputs:
      should_process: ${{ steps.check.outputs.should_process }}
    steps:
      - name: Check if issue should be processed
        id: check
        run: |
          LABELS='${{ toJson(github.event.issue.labels.*.name) }}'
          if echo "$LABELS" | grep -q "${{ env.COPILOT_LABEL }}"; then
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "Issue has copilot label, will process"
          else
            echo "should_process=false" >> $GITHUB_OUTPUT
            echo "Issue does not have copilot label, skipping"
          fi

  process-issue:
    needs: check-trigger
    if: needs.check-trigger.outputs.should_process == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: |
          echo "Processing issue #${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"
          echo "Labels: ${{ toJson(github.event.issue.labels.*.name) }}"

      - name: Create feature branch
        run: |
          BRANCH_NAME="copilot/issue-${{ github.event.issue.number }}"
          git checkout -b "$BRANCH_NAME"
          echo "Created branch: $BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Parse issue body
        id: parse
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "Parsing issue body for task details..."
          echo "$ISSUE_BODY" > /tmp/issue_body.md

          # Extract task description (between ## Task Description and next ##)
          TASK=$(sed -n '/## Task Description/,/^##/p' /tmp/issue_body.md | head -n -1 | tail -n +2)
          echo "Task: $TASK"

          # Extract acceptance criteria
          CRITERIA=$(sed -n '/## Acceptance Criteria/,/^##/p' /tmp/issue_body.md | head -n -1 | tail -n +2)
          echo "Criteria: $CRITERIA"

          echo "task<<EOF" >> $GITHUB_OUTPUT
          echo "$TASK" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Assign copilot to issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: ['copilot']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '> @copilot has been assigned to this issue and will begin working on it.\n\nBranch: `' + process.env.BRANCH_NAME + '`'
            });

      - name: Log execution start
        run: |
          mkdir -p logs/executions
          cat > logs/executions/$(date +%Y-%m-%d)-issue-${{ github.event.issue.number }}.json << 'EOF'
          {
            "execution_id": "exec-$(date +%Y%m%d-%H%M%S)-${{ github.event.issue.number }}",
            "issue_number": ${{ github.event.issue.number }},
            "issue_title": "${{ github.event.issue.title }}",
            "start_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "in_progress",
            "agent": "copilot",
            "branch": "${{ env.BRANCH_NAME }}"
          }
          EOF

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.BRANCH_NAME }}
          title: "feat: ${{ github.event.issue.title }}"
          body: |
            ## Summary

            Automated implementation for issue #${{ github.event.issue.number }}.

            Fixes #${{ github.event.issue.number }}

            ## Changes

            - Implementation based on issue requirements
            - Tests added per acceptance criteria

            ## Checklist

            - [ ] Code follows project conventions
            - [ ] Tests pass
            - [ ] Documentation updated if needed

            ---
            *Generated by @copilot via issue-driven automation*
          commit-message: "feat: implement #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
          labels: |
            automated
            copilot
          draft: false

      - name: Update execution log
        if: steps.create-pr.outputs.pull-request-number
        run: |
          echo "PR created: #${{ steps.create-pr.outputs.pull-request-number }}"
          # Update log with PR info
