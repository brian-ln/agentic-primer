name: Self-Improvement Analyzer

on:
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      min_executions:
        description: 'Minimum executions to analyze'
        required: false
        default: '5'

permissions:
  contents: read
  issues: write

env:
  MIN_EXECUTIONS: ${{ github.event.inputs.min_executions || '5' }}
  IMPROVEMENT_LABEL: self-improvement

jobs:
  analyze-logs:
    runs-on: ubuntu-latest
    outputs:
      improvements_found: ${{ steps.analyze.outputs.improvements_found }}
      improvement_count: ${{ steps.analyze.outputs.improvement_count }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Count execution logs
        id: count
        run: |
          LOG_COUNT=$(find logs/executions -name "*.json" 2>/dev/null | wc -l)
          echo "Found $LOG_COUNT execution logs"
          echo "log_count=$LOG_COUNT" >> $GITHUB_OUTPUT

          if [ "$LOG_COUNT" -lt "$MIN_EXECUTIONS" ]; then
            echo "Not enough logs to analyze (need $MIN_EXECUTIONS, have $LOG_COUNT)"
            echo "sufficient=false" >> $GITHUB_OUTPUT
          else
            echo "sufficient=true" >> $GITHUB_OUTPUT
          fi

      - name: Analyze execution patterns
        id: analyze
        if: steps.count.outputs.sufficient == 'true'
        run: |
          IMPROVEMENTS=()

          # Analyze success rates
          SUCCESS_COUNT=$(grep -l '"status": "success"' logs/executions/*.json 2>/dev/null | wc -l)
          TOTAL_COUNT=${{ steps.count.outputs.log_count }}
          SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_COUNT))

          echo "Success rate: $SUCCESS_RATE%"

          if [ "$SUCCESS_RATE" -lt 90 ]; then
            IMPROVEMENTS+=("Improve success rate (currently $SUCCESS_RATE%)")
          fi

          # Analyze execution times
          AVG_DURATION=$(cat logs/executions/*.json 2>/dev/null | \
            grep '"duration_seconds"' | \
            sed 's/.*: \([0-9]*\).*/\1/' | \
            awk '{sum+=$1; count++} END {print int(sum/count)}')

          if [ "${AVG_DURATION:-0}" -gt 120 ]; then
            IMPROVEMENTS+=("Reduce average execution time (currently ${AVG_DURATION}s)")
          fi

          # Analyze common errors
          ERROR_PATTERNS=$(cat logs/executions/*.json 2>/dev/null | \
            grep -o '"error": "[^"]*"' | \
            sort | uniq -c | sort -rn | head -3)

          if [ -n "$ERROR_PATTERNS" ]; then
            IMPROVEMENTS+=("Address recurring errors")
          fi

          # Output improvements
          echo "improvements_found=${#IMPROVEMENTS[@]}" >> $GITHUB_OUTPUT
          echo "improvement_count=${#IMPROVEMENTS[@]}" >> $GITHUB_OUTPUT

          # Save improvements to file for next step
          printf '%s\n' "${IMPROVEMENTS[@]}" > /tmp/improvements.txt

      - name: Create improvement issues
        if: steps.analyze.outputs.improvements_found > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const improvements = fs.readFileSync('/tmp/improvements.txt', 'utf8')
              .split('\n')
              .filter(line => line.trim());

            for (const improvement of improvements) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Self-Improvement] ${improvement}`,
                body: `## Improvement Opportunity

            This issue was automatically generated by the self-improvement analyzer based on execution log analysis.

            ### Finding
            ${improvement}

            ### Analysis Source
            - Execution logs analyzed: ${process.env.MIN_EXECUTIONS}+
            - Analysis date: ${new Date().toISOString().split('T')[0]}

            ### Suggested Actions
            - [ ] Review related execution logs
            - [ ] Identify root cause
            - [ ] Implement improvement
            - [ ] Verify improvement in subsequent runs

            ---
            *Generated by self-improvement-analyzer workflow*`,
                labels: ['${{ env.IMPROVEMENT_LABEL }}', 'copilot', 'automated']
              });

              console.log(`Created issue for: ${improvement}`);
            }

      - name: Summary
        run: |
          echo "## Self-Improvement Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Logs analyzed: ${{ steps.count.outputs.log_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- Improvements found: ${{ steps.analyze.outputs.improvement_count || 0 }}" >> $GITHUB_STEP_SUMMARY
