name: Issue Handler - @copilot Autonomous Processing

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  process-issue:
    name: Process Issue with @copilot
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'ai-task') ||
      contains(github.event.issue.labels.*.name, 'enhancement') ||
      contains(github.event.issue.labels.*.name, 'bug')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Environment
        id: setup
        run: |
          echo "Processing issue #${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"
          echo "Labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"
          echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          echo "issue_author=${{ github.event.issue.user.login }}" >> $GITHUB_OUTPUT

          # Set default branch and create feature branch
          echo "default_branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT
          echo "feature_branch=ai/issue-${{ github.event.issue.number }}" >> $GITHUB_OUTPUT

      - name: Validate Issue Format
        id: validate
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"

          # Check minimum requirements
          if [ ${#ISSUE_TITLE} -lt 5 ]; then
            echo "error=Issue title too short" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ ${#ISSUE_BODY} -lt 10 ]; then
            echo "error=Issue body too short" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "status=valid" >> $GITHUB_OUTPUT
          echo "Issue validation passed"

      - name: Create Feature Branch
        run: |
          git config --local user.email "copilot@github.com"
          git config --local user.name "GitHub Copilot"

          FEATURE_BRANCH="ai/issue-${{ steps.setup.outputs.issue_number }}"

          # Check if branch already exists
          if git rev-parse --verify "$FEATURE_BRANCH" >/dev/null 2>&1; then
            git checkout "$FEATURE_BRANCH"
            echo "Checked out existing branch: $FEATURE_BRANCH"
          else
            git checkout -b "$FEATURE_BRANCH"
            echo "Created new branch: $FEATURE_BRANCH"
          fi

      - name: Generate Issue Context
        id: context
        run: |
          # Create context file for issue processing
          cat > /tmp/issue-context.json << 'EOF'
          {
            "issue": {
              "number": ${{ github.event.issue.number }},
              "title": "${{ github.event.issue.title }}",
              "body": "${{ github.event.issue.body }}",
              "author": "${{ github.event.issue.user.login }}",
              "labels": ["${{ join(github.event.issue.labels.*.name, '", "') }}"],
              "created_at": "${{ github.event.issue.created_at }}",
              "url": "${{ github.event.issue.html_url }}"
            },
            "repository": {
              "name": "${{ github.repository }}",
              "url": "${{ github.server_url }}/${{ github.repository }}"
            },
            "timestamp": "$(date -Iseconds)"
          }
          EOF

          echo "context_file=/tmp/issue-context.json" >> $GITHUB_OUTPUT
          cat /tmp/issue-context.json

      - name: Determine Issue Type
        id: issue_type
        run: |
          LABELS="${{ join(github.event.issue.labels.*.name, ' ') }}"
          TITLE="${{ github.event.issue.title }}"

          if echo "$LABELS" | grep -q "bug"; then
            echo "type=bug" >> $GITHUB_OUTPUT
            echo "Issue classified as: BUG"
          elif echo "$LABELS" | grep -q "enhancement"; then
            echo "type=feature" >> $GITHUB_OUTPUT
            echo "Issue classified as: FEATURE"
          else
            echo "type=task" >> $GITHUB_OUTPUT
            echo "Issue classified as: TASK"
          fi

      - name: Process Issue - Bug Fix
        if: steps.issue_type.outputs.type == 'bug'
        run: |
          echo "Processing BUG issue #${{ steps.setup.outputs.issue_number }}"
          echo "Title: ${{ steps.setup.outputs.issue_title }}"

          # Create bug fix summary file
          mkdir -p .copilot
          cat > .copilot/issue-${{ steps.setup.outputs.issue_number }}-plan.md << 'EOF'
          # Bug Fix Plan - Issue #${{ steps.setup.outputs.issue_number }}

          ## Issue
          ${{ github.event.issue.title }}

          ## Description
          ${{ github.event.issue.body }}

          ## Plan
          1. Identify root cause
          2. Implement minimal fix
          3. Add regression test
          4. Verify fix resolves issue

          ## Success Criteria
          - [ ] Bug is reproducible in test
          - [ ] Root cause identified
          - [ ] Fix implemented
          - [ ] Tests pass
          - [ ] No regressions in related areas
          EOF

          echo "Bug fix plan created"

      - name: Process Issue - Feature Request
        if: steps.issue_type.outputs.type == 'feature'
        run: |
          echo "Processing FEATURE issue #${{ steps.setup.outputs.issue_number }}"
          echo "Title: ${{ steps.setup.outputs.issue_title }}"

          # Create feature implementation plan
          mkdir -p .copilot
          cat > .copilot/issue-${{ steps.setup.outputs.issue_number }}-plan.md << 'EOF'
          # Feature Implementation Plan - Issue #${{ steps.setup.outputs.issue_number }}

          ## Feature Request
          ${{ github.event.issue.title }}

          ## Description
          ${{ github.event.issue.body }}

          ## Implementation Plan
          1. Design feature interface
          2. Implement core functionality
          3. Add comprehensive tests
          4. Document usage and API
          5. Add to changelog

          ## Success Criteria
          - [ ] Feature is well-designed
          - [ ] Implementation is complete
          - [ ] Tests cover all use cases
          - [ ] Documentation is clear
          - [ ] No breaking changes to existing API
          EOF

          echo "Feature implementation plan created"

      - name: Process Issue - General Task
        if: steps.issue_type.outputs.type == 'task'
        run: |
          echo "Processing TASK issue #${{ steps.setup.outputs.issue_number }}"
          echo "Title: ${{ steps.setup.outputs.issue_title }}"

          # Create task execution plan
          mkdir -p .copilot
          cat > .copilot/issue-${{ steps.setup.outputs.issue_number }}-plan.md << 'EOF'
          # Task Execution Plan - Issue #${{ steps.setup.outputs.issue_number }}

          ## Task
          ${{ github.event.issue.title }}

          ## Description
          ${{ github.event.issue.body }}

          ## Implementation Plan
          1. Break down task into subtasks
          2. Execute each subtask
          3. Validate each completion
          4. Document changes
          5. Create pull request

          ## Success Criteria
          - [ ] All subtasks completed
          - [ ] Changes are well-tested
          - [ ] Code review ready
          - [ ] Documentation updated
          EOF

          echo "Task execution plan created"

      - name: Validate Syntax
        id: validate_syntax
        run: |
          echo "Validating generated files..."

          # Validate YAML if available
          if command -v yamllint &> /dev/null; then
            echo "Running yamllint..."
            yamllint .copilot/*.yml 2>/dev/null || echo "No YAML files to validate"
          fi

          # Validate shell scripts if available
          if command -v shellcheck &> /dev/null; then
            echo "Running shellcheck..."
            find . -name "*.sh" -type f | xargs shellcheck --severity=warning 2>/dev/null || echo "No shell scripts to validate"
          fi

          echo "validation_status=passed" >> $GITHUB_OUTPUT

      - name: Commit Changes
        id: commit
        run: |
          git add .copilot/issue-${{ steps.setup.outputs.issue_number }}-plan.md

          # Only commit if there are changes
          if git diff --cached --quiet; then
            echo "commit_created=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            git commit -m "feat: issue-plan for #${{ steps.setup.outputs.issue_number }}

            Issue: ${{ steps.setup.outputs.issue_title }}
            Type: ${{ steps.issue_type.outputs.type }}
            Author: ${{ steps.setup.outputs.issue_author }}

            Automated plan generation by @copilot"

            echo "commit_created=true" >> $GITHUB_OUTPUT
            echo "Commit created for issue #${{ steps.setup.outputs.issue_number }}"
          fi

      - name: Push Feature Branch
        if: steps.commit.outputs.commit_created == 'true'
        run: |
          FEATURE_BRANCH="ai/issue-${{ steps.setup.outputs.issue_number }}"
          git push -u origin "$FEATURE_BRANCH" || git push origin "$FEATURE_BRANCH"
          echo "Pushed feature branch: $FEATURE_BRANCH"

      - name: Create Pull Request
        if: steps.commit.outputs.commit_created == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "ai: ${{ steps.setup.outputs.issue_title }}"
          body: |
            ## Automated Issue Processing

            **Issue**: #${{ steps.setup.outputs.issue_number }}
            **Type**: ${{ steps.issue_type.outputs.type }}
            **Author**: @${{ steps.setup.outputs.issue_author }}

            This PR was automatically generated by @copilot to address the issue above.

            ### Changes
            - Generated issue handling plan
            - Created feature branch with analysis
            - Ready for implementation and review

            ### Checklist
            - [ ] Plan reviewed and approved
            - [ ] Implementation matches requirements
            - [ ] Tests are comprehensive
            - [ ] Documentation updated
            - [ ] No breaking changes

            Fixes #${{ steps.setup.outputs.issue_number }}
          branch: ai/issue-${{ steps.setup.outputs.issue_number }}
          commit-message: "feat: implement #${{ steps.setup.outputs.issue_number }}"
          labels: "ai-generated,automated"
          assignees: "${{ steps.setup.outputs.issue_author }}"
          delete-branch: false

      - name: Update Issue with PR Link
        if: steps.commit.outputs.commit_created == 'true'
        run: |
          # This is a simulation - in real execution would use GitHub API
          echo "Issue #${{ steps.setup.outputs.issue_number }} would be updated with PR link"
          echo "Comment would be posted: PR created and ready for review"

      - name: Record Issue Processing Result
        run: |
          # Log results to file for tracking
          mkdir -p .copilot/logs
          cat > .copilot/logs/issue-${{ steps.setup.outputs.issue_number }}-result.json << 'EOF'
          {
            "issue_number": ${{ steps.setup.outputs.issue_number }},
            "issue_title": "${{ steps.setup.outputs.issue_title }}",
            "issue_type": "${{ steps.issue_type.outputs.type }}",
            "issue_author": "${{ steps.setup.outputs.issue_author }}",
            "validation_status": "${{ steps.validate.outputs.status }}",
            "syntax_validation": "${{ steps.validate_syntax.outputs.validation_status }}",
            "commit_created": ${{ steps.commit.outputs.commit_created || 'false' }},
            "processing_timestamp": "$(date -Iseconds)",
            "feature_branch": "ai/issue-${{ steps.setup.outputs.issue_number }}"
          }
          EOF

          cat .copilot/logs/issue-${{ steps.setup.outputs.issue_number }}-result.json
          echo "Issue processing result recorded"

      - name: Workflow Success Summary
        if: success()
        run: |
          echo "✓ Issue #${{ steps.setup.outputs.issue_number }} processed successfully"
          echo "✓ Issue Type: ${{ steps.issue_type.outputs.type }}"
          echo "✓ Plan generated: .copilot/issue-${{ steps.setup.outputs.issue_number }}-plan.md"
          echo "✓ Validation: PASSED"
          echo "✓ PR Creation: Ready"

      - name: Workflow Failure Summary
        if: failure()
        run: |
          echo "✗ Issue #${{ steps.setup.outputs.issue_number }} processing failed"
          echo "✗ Check validation output above"
          echo "✗ Issue may need manual review"
