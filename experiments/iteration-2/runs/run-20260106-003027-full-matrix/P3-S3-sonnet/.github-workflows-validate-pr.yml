name: Validate Pull Request

# Purpose: Automated syntax and test validation for all PRs
# Success criterion #2: All generated files pass automated validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  validate-syntax:
    name: Syntax Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install validation tools
        run: |
          # YAML validation
          pip install yamllint

          # Shell script validation
          sudo apt-get update
          sudo apt-get install -y shellcheck

          # Markdown validation
          npm install -g markdownlint-cli

          # JSON validation (using Python)
          pip install jsonschema

      - name: Validate YAML files
        id: yaml-check
        run: |
          echo "Running yamllint..."

          # Find all YAML files
          yaml_files=$(find . -type f \( -name "*.yml" -o -name "*.yaml" \) -not -path "./.git/*")

          if [ -z "$yaml_files" ]; then
            echo "No YAML files found"
            exit 0
          fi

          # Create yamllint config
          cat > .yamllint << 'EOF'
          extends: default
          rules:
            line-length:
              max: 120
              level: warning
            comments:
              min-spaces-from-content: 1
            indentation:
              spaces: 2
              indent-sequences: true
          EOF

          # Run yamllint
          yamllint_output=$(yamllint $yaml_files 2>&1) || yaml_exit=$?

          if [ "${yaml_exit:-0}" -ne 0 ]; then
            echo "‚ùå YAML validation failed:"
            echo "$yamllint_output"
            echo "yaml_status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ All YAML files valid"
            echo "yaml_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Validate shell scripts
        id: shell-check
        run: |
          echo "Running shellcheck..."

          # Find all shell scripts
          shell_files=$(find . -type f \( -name "*.sh" -o -name "*.bash" \) -not -path "./.git/*")

          if [ -z "$shell_files" ]; then
            echo "No shell scripts found"
            exit 0
          fi

          # Run shellcheck
          shellcheck_output=$(shellcheck -x $shell_files 2>&1) || shell_exit=$?

          if [ "${shell_exit:-0}" -ne 0 ]; then
            echo "‚ùå Shell script validation failed:"
            echo "$shellcheck_output"
            echo "shell_status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ All shell scripts valid"
            echo "shell_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Validate Markdown files
        id: markdown-check
        run: |
          echo "Running markdownlint..."

          # Find all Markdown files
          md_files=$(find . -type f -name "*.md" -not -path "./.git/*" -not -path "./node_modules/*")

          if [ -z "$md_files" ]; then
            echo "No Markdown files found"
            exit 0
          fi

          # Create markdownlint config
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": { "line_length": 120 },
            "MD033": false,
            "MD041": false
          }
          EOF

          # Run markdownlint
          markdownlint_output=$(markdownlint $md_files 2>&1) || md_exit=$?

          if [ "${md_exit:-0}" -ne 0 ]; then
            echo "‚ö†Ô∏è  Markdown validation warnings:"
            echo "$markdownlint_output"
            echo "markdown_status=warning" >> $GITHUB_OUTPUT
            # Don't fail on markdown issues (warnings only)
          else
            echo "‚úÖ All Markdown files valid"
            echo "markdown_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Validate JSON files
        id: json-check
        run: |
          echo "Running JSON validation..."

          # Find all JSON files
          json_files=$(find . -type f -name "*.json" -not -path "./.git/*" -not -path "./node_modules/*")

          if [ -z "$json_files" ]; then
            echo "No JSON files found"
            exit 0
          fi

          # Validate each JSON file
          json_valid=true
          for file in $json_files; do
            if ! python3 -m json.tool "$file" > /dev/null 2>&1; then
              echo "‚ùå Invalid JSON: $file"
              json_valid=false
            fi
          done

          if [ "$json_valid" = false ]; then
            echo "json_status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "‚úÖ All JSON files valid"
            echo "json_status=passed" >> $GITHUB_OUTPUT
          fi

      - name: Post validation summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const yamlStatus = '${{ steps.yaml-check.outputs.yaml_status }}' || 'skipped';
            const shellStatus = '${{ steps.shell-check.outputs.shell_status }}' || 'skipped';
            const mdStatus = '${{ steps.markdown-check.outputs.markdown_status }}' || 'skipped';
            const jsonStatus = '${{ steps.json-check.outputs.json_status }}' || 'skipped';

            const statusEmoji = {
              'passed': '‚úÖ',
              'warning': '‚ö†Ô∏è',
              'failed': '‚ùå',
              'skipped': '‚è≠Ô∏è'
            };

            const body = `## Syntax Validation Results

            | Check | Status |
            |-------|--------|
            | YAML | ${statusEmoji[yamlStatus]} ${yamlStatus} |
            | Shell Scripts | ${statusEmoji[shellStatus]} ${shellStatus} |
            | Markdown | ${statusEmoji[mdStatus]} ${mdStatus} |
            | JSON | ${statusEmoji[jsonStatus]} ${jsonStatus} |

            ${yamlStatus === 'failed' || shellStatus === 'failed' || jsonStatus === 'failed'
              ? '‚ùå **Validation failed** - Please fix errors and push updates'
              : '‚úÖ **All validation checks passed**'}

            ---
            _Automated by validate-pr workflow_`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate-syntax

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect test framework
        id: detect-tests
        run: |
          # Detect package.json (Node.js)
          if [ -f "package.json" ]; then
            echo "framework=node" >> $GITHUB_OUTPUT
            echo "Detected Node.js project"
            exit 0
          fi

          # Detect requirements.txt or setup.py (Python)
          if [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
            echo "framework=python" >> $GITHUB_OUTPUT
            echo "Detected Python project"
            exit 0
          fi

          # Detect Go
          if [ -f "go.mod" ]; then
            echo "framework=go" >> $GITHUB_OUTPUT
            echo "Detected Go project"
            exit 0
          fi

          echo "framework=none" >> $GITHUB_OUTPUT
          echo "No test framework detected"

      - name: Run Node.js tests
        if: steps.detect-tests.outputs.framework == 'node'
        run: |
          npm ci
          npm test

      - name: Run Python tests
        if: steps.detect-tests.outputs.framework == 'python'
        run: |
          pip install -r requirements.txt || pip install -e .
          pytest --cov --cov-report=term-missing

      - name: Run Go tests
        if: steps.detect-tests.outputs.framework == 'go'
        run: |
          go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Skip tests
        if: steps.detect-tests.outputs.framework == 'none'
        run: |
          echo "‚ö†Ô∏è  No tests found - skipping test execution"
          echo "Consider adding tests for better code quality"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate-syntax

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-syntax, run-tests, security-scan]
    if: always()

    steps:
      - name: Check overall status
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'Syntax Validation', result: '${{ needs.validate-syntax.result }}' },
              { name: 'Tests', result: '${{ needs.run-tests.result }}' },
              { name: 'Security Scan', result: '${{ needs.security-scan.result }}' }
            ];

            const allPassed = jobs.every(job => job.result === 'success');
            const anyFailed = jobs.some(job => job.result === 'failure');

            const statusEmoji = (result) => {
              return result === 'success' ? '‚úÖ' :
                     result === 'failure' ? '‚ùå' :
                     result === 'skipped' ? '‚è≠Ô∏è' : '‚ö†Ô∏è';
            };

            const body = `## üìã PR Validation Summary

            | Job | Status |
            |-----|--------|
            ${jobs.map(j => `| ${j.name} | ${statusEmoji(j.result)} ${j.result} |`).join('\n')}

            ${allPassed ? '‚úÖ **All validation checks passed!** This PR is ready for human review.' : ''}
            ${anyFailed ? '‚ùå **Some checks failed.** Please review the errors and update your PR.' : ''}

            ---
            _Automated validation - Success criterion #2_`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

            if (anyFailed) {
              core.setFailed('Validation checks failed');
            }

# Why this file exists:
# - Success criterion #2: "All generated files pass automated validation"
# - Explicit requirement: "yamllint, shellcheck, markdownlint"
# - Quality gate: Prevents broken code from merging
# - Automated: No manual validation needed
# - Observable: Check results visible in PR
#
# Assumptions:
# - GitHub Actions has permissions (contents, pull-requests, checks)
# - Standard validation tools available (yamllint, shellcheck, markdownlint)
# - Tests follow common conventions (npm test, pytest, go test)
# - Security scanning with Trivy is acceptable
#
# How @copilot decided this was necessary:
# - Direct mapping to success criterion #2
# - Bootstrap prompt verification requirements
# - Best practice: Validate before merge
# - Multi-format validation (YAML, shell, markdown, JSON)
# - Complete workflow, not partial checks
