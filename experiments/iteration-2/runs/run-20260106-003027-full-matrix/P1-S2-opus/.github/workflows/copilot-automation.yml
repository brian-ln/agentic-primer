name: Copilot Automation

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  issues: write
  contents: read

jobs:
  process-issue:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'copilot')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Acknowledge issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const issueTitle = context.payload.issue.title;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## @copilot Processing

            This issue has been received and is being processed.

            **Issue:** #${issueNumber} - ${issueTitle}
            **Status:** Queued for @copilot

            @copilot will analyze this issue and create a pull request with the implementation.

            ---
            *Automated by copilot-automation workflow*`
            });

      - name: Add processing label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['processing']
            });

      - name: Log issue details
        run: |
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Issue Author: ${{ github.event.issue.user.login }}"
          echo "Labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"

  auto-label:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'

    steps:
      - name: Check for copilot mention
        id: check-mention
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const title = context.payload.issue.title || '';
            const hasCopilotMention = body.includes('@copilot') || title.includes('@copilot');
            const hasTaskPrefix = title.startsWith('[Task]:');
            return hasCopilotMention || hasTaskPrefix;
          result-encoding: string

      - name: Add copilot label
        if: steps.check-mention.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['copilot']
            });

  notify-completion:
    runs-on: ubuntu-latest
    needs: process-issue
    if: always() && needs.process-issue.result == 'success'

    steps:
      - name: Post success notification
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Processing Complete

            The issue has been processed by the automation workflow.

            **Next Steps:**
            1. @copilot will analyze the requirements
            2. A pull request will be created
            3. Reviewers will be auto-assigned via CODEOWNERS

            ---
            *Automated by copilot-automation workflow*`
            });
