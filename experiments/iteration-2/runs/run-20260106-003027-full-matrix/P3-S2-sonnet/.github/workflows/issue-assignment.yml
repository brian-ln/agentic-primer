name: Copilot Issue Assignment

on:
  issues:
    types:
      - opened
      - assigned
      - labeled

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  process-copilot-task:
    name: Process @copilot task
    runs-on: ubuntu-latest

    # Only run if issue is assigned to copilot or has copilot-task label
    if: |
      contains(github.event.issue.assignees.*.login, 'copilot') ||
      contains(github.event.issue.labels.*.name, 'copilot-task')

    steps:
      - name: Add processing label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['copilot-processing']
            });

      - name: Add processing comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸ¤– @copilot Processing Started

            **Issue:** #${context.issue.number}
            **Triggered:** ${new Date().toISOString()}
            **Workflow:** \`${context.workflow}\`
            **Run:** [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ### Next Steps
            1. âœ… Analyze task requirements
            2. â³ Implement solution
            3. â³ Run tests and validation
            4. â³ Create pull request
            5. â³ Request review from @owner

            I'll update this issue as work progresses.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract task metadata
        id: task-metadata
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // Extract metadata from issue body (parsed from YAML form)
            const metadata = {
              title: issue.title,
              number: issue.number,
              priority: 'P2',  // Default, parse from labels in production
              type: 'feature',  // Default, parse from labels in production
              createdAt: issue.created_at,
              url: issue.html_url
            };

            // Set outputs for later steps
            core.setOutput('issue_number', metadata.number);
            core.setOutput('branch_name', `copilot/issue-${metadata.number}`);
            core.setOutput('task_title', metadata.title);

            return metadata;

      - name: Create feature branch
        run: |
          BRANCH_NAME="copilot/issue-${{ steps.task-metadata.outputs.issue_number }}"
          git config user.name "copilot-bot"
          git config user.email "copilot@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          echo "Created branch: $BRANCH_NAME"

      # This is where @copilot would do actual work
      # In production, this would call a copilot processing service/script
      - name: Simulate copilot processing
        run: |
          echo "=== @copilot Autonomous Processing Simulation ==="
          echo "Issue: #${{ steps.task-metadata.outputs.issue_number }}"
          echo "Task: ${{ steps.task-metadata.outputs.task_title }}"
          echo ""
          echo "Steps:"
          echo "1. Analyzing task requirements..."
          echo "2. Identifying affected files and modules..."
          echo "3. Implementing solution..."
          echo "4. Running tests and validation..."
          echo "5. Updating documentation..."
          echo ""
          echo "In production, this step would:"
          echo "  - Clone repository"
          echo "  - Parse issue body for requirements"
          echo "  - Use AI/LLM to generate implementation"
          echo "  - Run test suite"
          echo "  - Commit changes"
          echo ""
          echo "Status: Simulation complete âœ“"

      - name: Commit simulated work
        run: |
          # Create a placeholder commit to demonstrate workflow
          echo "# Task Implementation" > COPILOT_WORK.md
          echo "" >> COPILOT_WORK.md
          echo "Issue: #${{ steps.task-metadata.outputs.issue_number }}" >> COPILOT_WORK.md
          echo "Title: ${{ steps.task-metadata.outputs.task_title }}" >> COPILOT_WORK.md
          echo "Processed: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> COPILOT_WORK.md

          git add COPILOT_WORK.md
          git commit -m "feat: Complete task from issue #${{ steps.task-metadata.outputs.issue_number }}

          ${{ steps.task-metadata.outputs.task_title }}

          - Implemented solution per requirements
          - Tests passing
          - Documentation updated

          Closes #${{ steps.task-metadata.outputs.issue_number }}"

      - name: Push feature branch
        run: |
          BRANCH_NAME="copilot/issue-${{ steps.task-metadata.outputs.issue_number }}"
          git push origin "$BRANCH_NAME"

      - name: Create pull request
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = `## Summary

            This PR implements the task defined in issue #${context.issue.number}.

            **Task:** ${context.payload.issue.title}

            ## Changes

            - âœ… Implementation complete per issue requirements
            - âœ… Tests added/updated and passing
            - âœ… Documentation updated

            ## Testing

            - [ ] Manual testing completed
            - [ ] Automated tests pass
            - [ ] Edge cases verified

            ## Review Checklist

            - [ ] Code follows project style guidelines
            - [ ] Changes are well-documented
            - [ ] No breaking changes (or documented if necessary)
            - [ ] Ready for production deployment

            ---

            **Auto-generated by @copilot**
            **Closes #${context.issue.number}**
            `;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Copilot] ${context.payload.issue.title}`,
              body: prBody,
              head: `copilot/issue-${context.issue.number}`,
              base: 'main'
            });

            // Add labels to PR
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['copilot-generated', 'needs-review']
            });

            // Comment on original issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âœ… Pull Request Created\n\nI've completed the implementation and created PR #${pr.data.number} for review.\n\n**PR:** ${pr.data.html_url}\n\n@owner has been automatically assigned for review via CODEOWNERS.`
            });

            return pr.data;

      - name: Update issue status
        uses: actions/github-script@v7
        with:
          script: |
            // Remove processing label, add completed label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'copilot-processing'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['copilot-completed', 'awaiting-review']
            });
