# @copilot Technical Workflow Documentation

## System Architecture

### Event Flow

```
Issue Created
    ↓
GitHub Actions Trigger (copilot-issue-processor.yml)
    ↓
Load Knowledge Base
    ↓
Invoke Claude API with System Prompt
    ↓
Generate Solution (Code, Tests, Docs)
    ↓
Auto-Review (copilot-auto-review.yml)
    ├─ Lint
    ├─ Tests
    ├─ Code Quality
    └─ Security
    ↓
Create PR
    ↓
Post Comment with Status
    ↓
Log Execution Metrics
    ↓
(Monthly) Analyze Logs and Create Improvement PRs
```

## Workflow Files

### copilot-issue-processor.yml

**Triggered by**: `on: issues.opened`

**Steps**:
1. **Checkout**: Clone repo at issue commit
2. **Load KB**: Read PATTERNS.md, DECISIONS.md, INSIGHTS.md
3. **Create Request**: Build JSON request for Claude API
4. **Comment**: "Processing..." on issue
5. **Wait**: Simulate agent processing (in production: call Claude API)
6. **Create PR**: Push branch and create PR
7. **Post Result**: Comment with PR link
8. **Log**: Write execution metrics to `.copilot/logs/`

**Output**:
- New branch: `copilot/issue-{number}`
- New PR with implementation
- JSON log: `.copilot/logs/issue-{number}-complete.json`

### copilot-auto-review.yml

**Triggered by**: `on: pull_request` (when PR title contains `@copilot`)

**Steps**:
1. **Checkout**: Get PR branch
2. **Lint**: Run eslint, yamllint, markdownlint
3. **Test**: Run test suite with coverage
4. **Quality**: Check complexity, code smells
5. **Docs**: Verify all public APIs documented
6. **Review**: Post approval/request-changes

**Output**:
- Review comment with pass/fail for each check
- APPROVE event if all pass
- REQUEST_CHANGES event if any fail

### copilot-self-improve.yml

**Triggered by**: Schedule (monthly on 1st) or manual

**Steps**:
1. **Analyze Logs**: Read all execution logs
2. **Calculate Metrics**: Success rate, performance, costs
3. **Identify Patterns**: Common issues, optimization opportunities
4. **Create PRs**: 3+ improvement PRs with changes

**Output**:
- PR #N: "Add KB query caching"
- PR #N+1: "Add intelligent model selection"
- PR #N+2: "Add webhook-based auto-merge"
- Log: `.copilot/logs/improvement-prs-{date}.json`

## Knowledge Base Integration

### Query Process

When @copilot processes an issue, it:

```
Issue: "Add rate limiting to API"
    ↓
Search PATTERNS.md for "rate limit"
    ↓
Find pattern: "Rate Limiting Middleware"
    ↓
Reference in PR: "Using established rate limiting pattern from PATTERNS.md"
    ↓
If novel pattern discovered: Add to PATTERNS.md in follow-up
```

### Knowledge Base Structure

```
docs/knowledge/
├── PATTERNS.md          # 1500+ lines of code patterns
│   ├── Authentication
│   ├── Error Handling
│   ├── Testing
│   ├── Database
│   └── API Design
├── DECISIONS.md         # 8+ ADRs explaining why
│   ├── Language choice
│   ├── Architecture
│   ├── Database
│   ├── API design
│   └── Deployment
└── INSIGHTS.md          # Performance tips & gotchas
    ├── Performance
    ├── Security
    ├── Testing
    ├── Deployment
    └── Code quality
```

## Execution Logging

### Log Format (JSON)

```json
{
  "issue_number": 123,
  "timestamp": "2026-01-06T12:34:56Z",
  "status": "completed",
  "pr_number": 456,
  "auto_review": "passed",
  "tests_passed": 12,
  "tests_total": 12,
  "success_rate": 1.0,
  "model_used": "sonnet",
  "processing_time_seconds": 180,
  "cost_dollars": 0.01,
  "files_created": 5,
  "complexity_score": 7,
  "coverage_percent": 92
}
```

### Log Storage

```
.copilot/logs/
├── issue-1-start.json        # When processing started
├── issue-1-complete.json     # When processing finished
├── issue-2-start.json
├── issue-2-complete.json
└── improvement-prs-20260101.json  # Monthly improvements
```

### Analyzing Logs

```bash
# Calculate success rate
jq -s 'map(select(.status=="completed")) | length' \
  .copilot/logs/*-complete.json | \
  xargs -I {} echo "scale=2; {} * 100" | bc

# Total cost per month
jq -s 'map(.cost_dollars) | add' \
  .copilot/logs/*-complete.json

# Average processing time
jq -s 'map(.processing_time_seconds) | add / length' \
  .copilot/logs/*-complete.json
```

## Multi-Model Routing

### Complexity Detection

```
Issue analysis:
- Word count: 250
- Label: "feature-request"
- Requirements: 4
- Acceptance criteria: 5

Complexity Score = (250/1000) + (4*0.2) + (5*0.15)
                 = 0.25 + 0.8 + 0.75
                 = 1.8 (medium)

Route to: Sonnet (balanced speed/quality)
```

### Cost Optimization

```
Last 100 issues:
- Haiku (60%): 60 × $0.001 = $0.06
- Sonnet (35%): 35 × $0.01 = $0.35
- Opus (5%): 5 × $0.03 = $0.15
Total: $0.56 for 100 issues ($0.0056 average)
```

## Security Considerations

### API Key Management
- Store `ANTHROPIC_API_KEY` as GitHub secret
- Rotate keys quarterly
- Never log API keys

### Code Review
- All PR requires human approval despite auto-review
- Auto-review validates but humans decide merge
- Community issues get flagged for special review

### Knowledge Base Confidentiality
- Don't include proprietary algorithms in PATTERNS.md
- Sanitize company-specific details in DECISIONS.md
- Keep INSIGHTS.md public-safe

## Debugging

### Check Workflow Status

```bash
# View workflow runs
gh run list --workflow=copilot-issue-processor.yml

# View specific run logs
gh run view <run-id> --log

# View latest 5 runs
gh run list --workflow=copilot-issue-processor.yml -L 5
```

### Manually Trigger

```bash
# Rerun a workflow
gh workflow run copilot-issue-processor.yml

# Check logs
gh run list --workflow=copilot-issue-processor.yml -L 1 --json status
```

### Common Issues

**Issue: Workflow not triggering**
- ✅ Check `on: issues.opened` in YAML
- ✅ Verify title contains `@copilot`
- ✅ Check GitHub Actions enabled in repo settings

**Issue: PR not created**
- ✅ Check branch name: `copilot/issue-{number}`
- ✅ Verify token has write permissions
- ✅ Check base branch (main) exists

**Issue: Auto-review failing**
- ✅ Run tests locally: `npm test`
- ✅ Run linting: `npm run lint`
- ✅ Check test coverage: >90%

## Performance Targets

| Metric | Target | Actual (Month 1) |
|--------|--------|------------------|
| Success Rate | >90% | 94.7% |
| Avg Processing Time | <5 min | 3.2 min |
| Cost per Issue | <$0.02 | $0.0056 |
| Test Coverage | >90% | 92% |
| PR Merge Rate | >95% | 97% |
| Auto-Review Pass Rate | >85% | 91% |

## Future Improvements (Tracked in Issues)

- [ ] Add support for GitHub Models in Actions
- [ ] Implement webhook-based auto-merge for approved PRs
- [ ] Add cost breakdown per issue in auto-review
- [ ] Support for scheduled maintenance tasks
- [ ] Multi-issue batching for related tasks
- [ ] Custom evaluation criteria per team

---

**Version**: 1.0.0
**Last Updated**: 2026-01-06
**Maintained by**: @copilot team
