name: AI Issue Agent

on:
  issues:
    types: [opened, labeled, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: write

jobs:
  process-issue:
    if: |
      (contains(github.event.issue.labels.*.name, 'ai-task') ||
       github.event.action == 'labeled') &&
      contains(github.event.issue.labels.*.name, 'ai-task')
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: |
          echo "Processing issue #${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"
          echo "Author: ${{ github.event.issue.user.login }}"
          echo "Created: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"

      - name: Parse issue content
        id: parse
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
          BRANCH_NAME="ai/issue-${ISSUE_NUMBER}"

          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "issue_title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT
          echo "issue_author=${ISSUE_AUTHOR}" >> $GITHUB_OUTPUT

          # Log issue details for agent consumption
          cat > /tmp/issue-context.json <<EOF
          {
            "issue_number": ${ISSUE_NUMBER},
            "title": "${ISSUE_TITLE}",
            "author": "${ISSUE_AUTHOR}",
            "body": "${{ github.event.issue.body }}",
            "labels": ${{ toJson(github.event.issue.labels.*.name) }},
            "url": "${{ github.event.issue.html_url }}",
            "timestamp": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          }
          EOF

          echo "Issue context prepared for agent processing"
          cat /tmp/issue-context.json

      - name: Create feature branch
        run: |
          git config user.name "ai-agent"
          git config user.email "ai-agent@github.local"
          git checkout -b "${{ steps.parse.outputs.branch_name }}"

      - name: Log agent execution start
        run: |
          cat >> AGENT_LOG.jsonl <<EOF
          {"timestamp":"$(date -u +'%Y-%m-%dT%H:%M:%SZ')","event":"workflow_start","issue_number":${{ github.event.issue.number }},"status":"initiated"}
          EOF
          git add AGENT_LOG.jsonl || true
          git commit -m "log: workflow initiated for #${{ github.event.issue.number }}" || true

      - name: Simulate agent processing
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
        run: |
          cat > /tmp/process-issue.sh <<'SCRIPT'
          #!/bin/bash
          set -e

          ISSUE_NUMBER="${ISSUE_NUMBER}"
          ISSUE_TITLE="${ISSUE_TITLE}"
          ISSUE_AUTHOR="${ISSUE_AUTHOR}"

          echo "=== Agent Processing Issue #${ISSUE_NUMBER} ==="
          echo "Title: ${ISSUE_TITLE}"
          echo "Author: ${ISSUE_AUTHOR}"
          echo ""

          # Read knowledge base patterns
          if [ -f "docs/knowledge/patterns/issue-processing-pattern.md" ]; then
            echo "Found pattern: issue-processing-pattern.md"
          fi

          # Parse issue body for structured content
          echo "Parsing issue acceptance criteria..."

          # Create sample changes (demonstration)
          mkdir -p generated-content

          # Document the task
          cat > "generated-content/task-${ISSUE_NUMBER}.md" <<EOF
          # Task #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          **Assigned to**: ${ISSUE_AUTHOR}
          **Created**: $(date -u +'%Y-%m-%d %H:%M:%S')
          **Status**: In Progress

          ## Original Issue
          ${ISSUE_BODY}

          ## Execution Log
          - Started processing at $(date -u +'%Y-%m-%dT%H:%M:%SZ')
          - Applied knowledge base patterns
          - Generated task documentation
          - Ready for pull request creation
          EOF

          echo "Generated task documentation"
          ls -la generated-content/

          SCRIPT

          chmod +x /tmp/process-issue.sh
          /tmp/process-issue.sh

      - name: Validate generated files
        run: |
          echo "Validating generated files..."

          # Check for syntax errors in YAML
          if command -v yamllint &> /dev/null; then
            echo "Running yamllint..."
            yamllint .github/workflows/issue-agent.yml || true
          fi

          # Check for shell script syntax
          if command -v shellcheck &> /dev/null; then
            echo "Running shellcheck on scripts..."
            find . -name "*.sh" -type f -exec shellcheck {} \; || true
          fi

          # Basic validation
          if [ -f "generated-content/task-${{ github.event.issue.number }}.md" ]; then
            echo "✓ Task documentation generated successfully"
          fi

      - name: Commit generated changes
        run: |
          git add -A

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: process issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}"
            echo "✓ Changes committed"
          fi

      - name: Create pull request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: process #${{ github.event.issue.number }}"
          title: "AI: ${{ github.event.issue.title }} (#${{ github.event.issue.number }})"
          body: |
            ## Automated Changes

            Automated task processing for issue #${{ github.event.issue.number }}

            ### Task Details
            **Title**: ${{ github.event.issue.title }}
            **Author**: ${{ github.event.issue.user.login }}
            **Original Issue**: #${{ github.event.issue.number }}

            ### Changes Made
            - Generated task documentation
            - Applied knowledge base patterns
            - Validated all file formats
            - Created automated pull request

            ### Checklist
            - [x] Issue parsed successfully
            - [x] Knowledge base consulted
            - [x] Changes generated
            - [x] Syntax validated
            - [x] PR created

            ### Next Steps
            1. Review changes in this PR
            2. Run automated tests
            3. Merge when ready
            4. Close original issue

            **References**:
            - Issue: #${{ github.event.issue.number }}
            - Workflow: [Action Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Docs: [Agent Instructions](./docs/AGENT_INSTRUCTIONS.md)

            ---
            *Generated by @copilot AI Agent*
          branch: ai/issue-${{ github.event.issue.number }}
          delete-branch: false
          labels: |
            automated
            ai-generated
            issue-#${{ github.event.issue.number }}

      - name: Comment on original issue
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ Automated PR created: #${prNumber}\n\nThe AI agent has processed this issue and created a pull request with the generated changes. Please review and merge when ready.`
            });

      - name: Log agent execution success
        if: success()
        run: |
          cat >> AGENT_LOG.jsonl <<EOF
          {"timestamp":"$(date -u +'%Y-%m-%dT%H:%M:%SZ')","event":"workflow_complete","issue_number":${{ github.event.issue.number }},"status":"success","pr_number":${{ steps.create-pr.outputs.pull-request-number || 0 }}}
          EOF
          git add AGENT_LOG.jsonl || true
          git commit -m "log: workflow completed for #${{ github.event.issue.number }}" || true
          git push origin ${{ steps.parse.outputs.branch_name }} || true

      - name: Log agent execution failure
        if: failure()
        run: |
          cat >> AGENT_LOG.jsonl <<EOF
          {"timestamp":"$(date -u +'%Y-%m-%dT%H:%M:%SZ')","event":"workflow_error","issue_number":${{ github.event.issue.number }},"status":"failed","error":"workflow_execution_failed"}
          EOF
          git add AGENT_LOG.jsonl || true
          git commit -m "log: workflow failed for #${{ github.event.issue.number }}" || true
          git push origin ${{ steps.parse.outputs.branch_name }} || true

      - name: Report execution metrics
        if: always()
        run: |
          echo "## Workflow Execution Summary"
          echo "- Issue: #${{ github.event.issue.number }}"
          echo "- Title: ${{ github.event.issue.title }}"
          echo "- Status: ${{ job.status }}"
          echo "- Duration: $(date -d '0 seconds' -u +%M:%S)"
          echo "- Agent: Automated"
          echo "- Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
