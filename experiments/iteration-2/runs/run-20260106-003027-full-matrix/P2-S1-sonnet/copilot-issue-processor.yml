name: Copilot Issue Processor

on:
  issues:
    types: [labeled, opened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  process-issue:
    # Only run when copilot:ready label is added or @copilot is mentioned
    if: |
      (github.event.label.name == 'copilot:ready') ||
      (github.event.issue.assignees.*.login contains 'copilot') ||
      (github.event.comment && contains(github.event.comment.body, '@copilot'))

    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: .github/scripts

      - name: Add processing label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['copilot:processing']
            });

      - name: Add initial comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ¤– @copilot is analyzing this issue and will create an implementation plan shortly...\n\n_Processing started at: ' + new Date().toISOString() + '_'
            });

      - name: Process issue and extract requirements
        id: process
        run: |
          node process-issue.js \
            --issue-number ${{ github.event.issue.number }} \
            --repository "${{ github.repository }}" \
            --token "${{ secrets.GITHUB_TOKEN }}"
        working-directory: .github/scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Query knowledge base
        id: knowledge
        run: |
          node query-knowledge-base.js \
            --requirements "${{ steps.process.outputs.requirements }}" \
            --issue-type "${{ steps.process.outputs.issue_type }}"
        working-directory: .github/scripts

      - name: Generate implementation plan
        id: plan
        run: |
          node generate-implementation-plan.js \
            --requirements "${{ steps.process.outputs.requirements }}" \
            --knowledge "${{ steps.knowledge.outputs.relevant_docs }}" \
            --issue-number ${{ github.event.issue.number }}
        working-directory: .github/scripts

      - name: Post implementation plan as comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('.github/scripts/plan.md', 'utf8');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## ðŸ“‹ Implementation Plan\n\n' + plan + '\n\n---\n_I will now begin implementation. You can track progress in the draft PR._'
            });

      - name: Configure git
        run: |
          git config user.name "copilot[bot]"
          git config user.email "copilot[bot]@users.noreply.github.com"

      - name: Create feature branch
        run: |
          BRANCH_NAME="copilot/issue-${{ github.event.issue.number }}-$(echo '${{ github.event.issue.title }}' | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | cut -c1-50)"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Execute implementation
        id: implement
        run: |
          # This would execute the actual implementation
          # For simulation purposes, we create placeholder files

          FILES=$(cat .github/scripts/plan.json | jq -r '.files[]')

          for file in $FILES; do
            mkdir -p "$(dirname "$file")"
            echo "// Implementation for issue #${{ github.event.issue.number }}" > "$file"
            echo "// Generated by @copilot" >> "$file"
            echo "" >> "$file"
            cat ".github/scripts/templates/$(basename "$file")" >> "$file" 2>/dev/null || true
          done

          git add .
          git commit -m "feat: implement #${{ github.event.issue.number }} - ${{ github.event.issue.title }}

          This implementation addresses the requirements outlined in issue #${{ github.event.issue.number }}.

          Generated by @copilot

          Relates-to: #${{ github.event.issue.number }}"

      - name: Push feature branch
        run: |
          git push origin "${{ env.BRANCH_NAME }}"

      - name: Create draft pull request
        id: create_pr
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('.github/scripts/plan.md', 'utf8');
            const issue = context.payload.issue;

            const prBody = `## Summary

            This PR implements the requirements from issue #${issue.number}.

            ## Implementation Details

            ${plan}

            ## Testing

            - [ ] Unit tests added/updated
            - [ ] Integration tests passing
            - [ ] Manual testing completed

            ## Related Issues

            Closes #${issue.number}

            ---
            ðŸ¤– _Generated by @copilot - Review and merge when ready_`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `feat: ${issue.title}`,
              head: process.env.BRANCH_NAME,
              base: 'main',
              body: prBody,
              draft: true
            });

            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_url', pr.data.html_url);

            return pr.data.number;

      - name: Update issue with PR link
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… Implementation complete! \n\nPlease review the draft PR: #${{ steps.create_pr.outputs.pr_number }}\n\n${{ steps.create_pr.outputs.pr_url }}`
            });

            // Update labels
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'copilot:processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['copilot:complete']
            });

      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âŒ @copilot encountered an error while processing this issue.\n\nPlease check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['copilot:error']
            });

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'copilot:processing'
            }).catch(() => {});
