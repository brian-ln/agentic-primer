name: Copilot PR Auto-Assign

on:
  pull_request:
    types: [opened]

jobs:
  auto-assign:
    # Only run for PRs created by copilot bot
    if: github.event.pull_request.user.login == 'copilot' || github.event.pull_request.user.login == 'copilot-bot'
    runs-on: ubuntu-latest

    permissions:
      issues: read
      pull-requests: write

    steps:
      - name: Extract issue number from PR
        id: extract
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const prBody = context.payload.pull_request.body || '';

            // Match "Closes #123" or "Fixes #123" or "Resolves #123"
            const issueMatch = prBody.match(/(?:Closes|Fixes|Resolves)\s+#(\d+)/i);

            if (!issueMatch) {
              core.setOutput('has_issue', 'false');
              return;
            }

            const issueNumber = issueMatch[1];
            core.setOutput('has_issue', 'true');
            core.setOutput('issue_number', issueNumber);

            // Fetch the issue to get creator
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            core.setOutput('issue_creator', issue.user.login);
            core.setOutput('issue_title', issue.title);

      - name: Assign PR to issue creator
        if: steps.extract.outputs.has_issue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const issueCreator = '${{ steps.extract.outputs.issue_creator }}';
            const prNumber = context.payload.pull_request.number;

            // Request review from issue creator
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                reviewers: [issueCreator]
              });

              core.info(`‚úÖ Requested review from @${issueCreator}`);
            } catch (error) {
              core.warning(`‚ö†Ô∏è Could not request review from @${issueCreator}: ${error.message}`);
            }

            // Also assign the PR
            try {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                assignees: [issueCreator]
              });

              core.info(`‚úÖ Assigned PR to @${issueCreator}`);
            } catch (error) {
              core.warning(`‚ö†Ô∏è Could not assign PR to @${issueCreator}: ${error.message}`);
            }

      - name: Add labels
        if: steps.extract.outputs.has_issue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const labels = ['copilot-generated', 'needs-review'];

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: labels
            });

            core.info(`‚úÖ Added labels: ${labels.join(', ')}`);

      - name: Post welcome comment
        if: steps.extract.outputs.has_issue == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const issueCreator = '${{ steps.extract.outputs.issue_creator }}';
            const issueNumber = '${{ steps.extract.outputs.issue_number }}';
            const issueTitle = '${{ steps.extract.outputs.issue_title }}';

            const comment = `üëã **@${issueCreator}**

            I've implemented your request from issue #${issueNumber}: "${issueTitle}"

            ### What I did:
            - ‚úÖ Analyzed your requirements
            - ‚úÖ Searched our knowledge base for best practices
            - ‚úÖ Generated implementation with tests
            - ‚úÖ Created this pull request

            ### Next steps for you:
            1. üìñ **Review the code** - Check if implementation matches your expectations
            2. üß™ **Test locally** - Pull the branch and verify functionality
            3. üí¨ **Provide feedback** - Request changes or ask questions
            4. ‚úÖ **Approve & merge** - When you're happy with the implementation

            ### Knowledge base context applied:
            This implementation follows our established patterns and standards from the knowledge base.

            ---

            **Note:** This is a draft PR. Feel free to request any changes or improvements!

            Generated with ‚ù§Ô∏è by @copilot`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      - name: Handle PRs without linked issues
        if: steps.extract.outputs.has_issue == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const comment = `‚ö†Ô∏è **Warning: No linked issue found**

            This PR was created by @copilot but doesn't reference an issue using the standard syntax.

            **Expected format in PR description:**
            \`\`\`
            Closes #123
            or
            Fixes #456
            or
            Resolves #789
            \`\`\`

            **Why this matters:**
            - Auto-assignment won't work without a linked issue
            - Issue won't auto-close when PR merges
            - Difficult to trace PR back to original request

            **To fix:**
            Edit the PR description to include "Closes #ISSUE_NUMBER"`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

            // Add warning label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: ['copilot-generated', 'missing-issue-link']
            });
