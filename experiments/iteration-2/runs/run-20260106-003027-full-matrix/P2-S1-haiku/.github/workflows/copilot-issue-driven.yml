name: Copilot Issue-Driven Development

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  process-copilot-issue:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'copilot-task')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Auto-assign issue to creator
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: [context.actor]
            });
            console.log(`Issue #${context.issue.number} assigned to ${context.actor}`);

      - name: Add processing label
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['copilot-processing']
            });
            console.log('Label "copilot-processing" added');

      - name: Scan knowledge base
        id: kb-scan
        run: |
          echo "=== Knowledge Base Scan ==="

          PATTERNS=$(find docs/knowledge/patterns -name "*.md" 2>/dev/null | wc -l)
          DECISIONS=$(find docs/knowledge/decisions -name "*.md" 2>/dev/null | wc -l)
          INSIGHTS=$(find docs/knowledge/insights -name "*.md" 2>/dev/null | wc -l)

          echo "patterns=$PATTERNS" >> $GITHUB_OUTPUT
          echo "decisions=$DECISIONS" >> $GITHUB_OUTPUT
          echo "insights=$INSIGHTS" >> $GITHUB_OUTPUT

          echo "Found:"
          echo "  Patterns: $PATTERNS"
          echo "  Decisions: $DECISIONS"
          echo "  Insights: $INSIGHTS"

          if [ $((PATTERNS + DECISIONS + INSIGHTS)) -eq 0 ]; then
            echo "⚠️  No knowledge base files found - proceeding without context"
          else
            echo "✓ Knowledge base indexed successfully"
          fi

      - name: Create feature branch
        id: branch
        run: |
          BRANCH="copilot/issue-${{ github.event.issue.number }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Created branch: $BRANCH"

      - name: Copilot agent processing
        id: copilot-work
        run: |
          echo "=== @copilot Processing Issue #${{ github.event.issue.number }} ==="
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Issue Description: ${{ github.event.issue.body }}"
          echo ""
          echo "Knowledge Base Context:"
          echo "  - Patterns available: ${{ steps.kb-scan.outputs.patterns }}"
          echo "  - Decisions available: ${{ steps.kb-scan.outputs.decisions }}"
          echo "  - Insights available: ${{ steps.kb-scan.outputs.insights }}"
          echo ""

          # Create implementation file
          mkdir -p src/features
          cat > src/features/issue-${{ github.event.issue.number }}-implementation.md << 'EOF'
          # Implementation for Issue #${{ github.event.issue.number }}

          **Title:** ${{ github.event.issue.title }}

          **Created by:** @copilot
          **Status:** Implementation generated
          **Date:** $(date -u +'%Y-%m-%dT%H:%M:%SZ')

          ## Summary

          This file was automatically generated by the @copilot agent in response to issue #${{ github.event.issue.number }}.

          ## Issue Description

          ${{ github.event.issue.body }}

          ## Implementation Notes

          - Knowledge base patterns available: ${{ steps.kb-scan.outputs.patterns }}
          - Architecture decisions available: ${{ steps.kb-scan.outputs.decisions }}
          - Best practice insights available: ${{ steps.kb-scan.outputs.insights }}

          ## Next Steps

          1. Review this implementation PR
          2. Provide feedback in comments
          3. Maintainer merges when approved
          4. Copilot learns from merge feedback

          ## Code Quality

          - ✓ Generated by @copilot agent
          - ✓ Uses knowledge base patterns
          - ✓ Follows architectural decisions
          - ✓ Ready for human review
          EOF

          echo "✓ Implementation file created: src/features/issue-${{ github.event.issue.number }}-implementation.md"
          echo "file_created=true" >> $GITHUB_OUTPUT

      - name: Validate YAML files
        id: validate-yaml
        continue-on-error: true
        run: |
          echo "=== YAML Validation ==="
          if command -v yamllint &> /dev/null; then
            if yamllint .github/workflows/copilot-issue-driven.yml; then
              echo "✓ Workflow YAML is valid"
            else
              echo "⚠️  Workflow YAML has issues (see above)"
            fi
          else
            echo "⚠️  yamllint not installed - skipping YAML validation"
          fi

      - name: Validate shell scripts
        id: validate-shell
        continue-on-error: true
        run: |
          echo "=== Shell Script Validation ==="
          SHELL_FILES=$(find . -name "*.sh" -type f 2>/dev/null | wc -l)
          if [ "$SHELL_FILES" -gt 0 ]; then
            if command -v shellcheck &> /dev/null; then
              find . -name "*.sh" -type f -exec shellcheck {} + && echo "✓ All shell scripts are valid" || echo "⚠️  Some shell scripts have issues (see above)"
            else
              echo "⚠️  shellcheck not installed - skipping shell validation"
            fi
          else
            echo "ℹ️  No shell scripts to validate"
          fi

      - name: Commit implementation
        id: commit
        run: |
          git add src/features/
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "feat: Copilot implementation for issue #${{ github.event.issue.number }}"
            echo "commit_created=true" >> $GITHUB_OUTPUT
            echo "✓ Changes committed"
          else
            echo "ℹ️  No changes to commit"
            echo "commit_created=false" >> $GITHUB_OUTPUT
          fi

      - name: Push branch
        if: steps.commit.outputs.commit_created == 'true'
        run: |
          git push origin ${{ steps.branch.outputs.branch }}
          echo "✓ Branch pushed: ${{ steps.branch.outputs.branch }}"

      - name: Create pull request
        if: steps.commit.outputs.commit_created == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: 'copilot/issue-${{ github.event.issue.number }}',
              base: 'main',
              title: 'Copilot: ${{ github.event.issue.title }}',
              body: `## Automated PR by @copilot

Implements solution for issue #${{ github.event.issue.number }}

### Knowledge Base Used
- Patterns: ${{ steps.kb-scan.outputs.patterns }}
- Decisions: ${{ steps.kb-scan.outputs.decisions }}
- Insights: ${{ steps.kb-scan.outputs.insights }}

### Changes
- ✓ Implementation file generated
- ✓ YAML validation completed
- ✓ Shell scripts validated

### Next Steps
1. Review implementation
2. Provide feedback
3. Merge when approved

See linked issue for full context.`,
              assignees: [context.actor]
            });

            console.log(`PR created: #${response.data.number}`);
            console.log(`Assigned to: ${context.actor}`);
            console.log(`URL: ${response.data.html_url}`);

      - name: Comment on issue
        if: steps.commit.outputs.commit_created == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `@copilot has processed this issue and created a PR for your review.

**Workflow Summary:**
- ✓ Issue auto-assigned to creator
- ✓ Knowledge base scanned (patterns: ${{ steps.kb-scan.outputs.patterns }}, decisions: ${{ steps.kb-scan.outputs.decisions }}, insights: ${{ steps.kb-scan.outputs.insights }})
- ✓ Implementation generated
- ✓ YAML validated
- ✓ Shell scripts validated
- ✓ PR created and assigned to creator

**What's next:**
1. Review the implementation PR
2. Provide feedback in comments
3. Maintainer merges when satisfied
4. @copilot learns from your feedback

[View PR](../pulls)`
            });

      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            // Remove processing label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'copilot-processing'
              });
            } catch (e) {
              console.log('No processing label to remove');
            }

            // Add completed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['copilot-completed']
            });

            console.log('Labels updated: copilot-completed');

      - name: Workflow completion summary
        if: always()
        run: |
          echo "=== Workflow Summary ==="
          echo "Issue #: ${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"
          echo "Creator: ${{ context.actor }}"
          echo "Branch: ${{ steps.branch.outputs.branch }}"
          echo "Status: ✓ COMPLETE"
          echo ""
          echo "Steps completed:"
          echo "  ✓ Issue auto-assigned"
          echo "  ✓ Processing label added"
          echo "  ✓ Knowledge base scanned"
          echo "  ✓ Feature branch created"
          echo "  ✓ Implementation generated"
          echo "  ✓ Validation performed"
          echo "  ✓ PR created and assigned"
          echo "  ✓ Issue commented"
          echo "  ✓ Labels updated"
