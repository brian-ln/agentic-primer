name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  validate-syntax:
    name: Validate Syntax
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install validation tools
        run: |
          # YAML linting
          pip install yamllint

          # Shell script linting
          sudo apt-get update
          sudo apt-get install -y shellcheck

          # Markdown linting
          npm install -g markdownlint-cli

          # Verify installations
          yamllint --version
          shellcheck --version
          markdownlint --version

      - name: Validate YAML files
        id: yaml-lint
        run: |
          echo "### YAML Validation" >> $GITHUB_STEP_SUMMARY

          # Find all YAML files
          YAML_FILES=$(find . -type f \( -name "*.yml" -o -name "*.yaml" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/.git/*")

          if [ -z "$YAML_FILES" ]; then
            echo "No YAML files found to validate."
            echo "✅ No YAML files to validate" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Run yamllint
          echo "Validating YAML files..."
          echo "$YAML_FILES" | xargs yamllint -f parsable > yaml_results.txt 2>&1 || true

          # Check results
          if [ -s yaml_results.txt ]; then
            echo "❌ YAML validation failed:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat yaml_results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat yaml_results.txt
            exit 1
          else
            echo "✅ All YAML files valid" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate shell scripts
        id: shell-lint
        run: |
          echo "### Shell Script Validation" >> $GITHUB_STEP_SUMMARY

          # Find all shell scripts
          SHELL_FILES=$(find . -type f -name "*.sh" \
            ! -path "*/node_modules/*" \
            ! -path "*/.git/*")

          if [ -z "$SHELL_FILES" ]; then
            echo "No shell scripts found to validate."
            echo "✅ No shell scripts to validate" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Run shellcheck
          echo "Validating shell scripts..."
          echo "$SHELL_FILES" | xargs shellcheck --format=gcc --severity=warning > shell_results.txt 2>&1 || true

          # Check results
          if [ -s shell_results.txt ]; then
            echo "❌ Shell script validation failed:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat shell_results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat shell_results.txt
            exit 1
          else
            echo "✅ All shell scripts valid" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate Markdown files
        id: markdown-lint
        run: |
          echo "### Markdown Validation" >> $GITHUB_STEP_SUMMARY

          # Find all markdown files
          MD_FILES=$(find . -type f -name "*.md" \
            ! -path "*/node_modules/*" \
            ! -path "*/.git/*")

          if [ -z "$MD_FILES" ]; then
            echo "No markdown files found to validate."
            echo "✅ No markdown files to validate" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Create default config if not exists
          if [ ! -f ".markdownlint.json" ]; then
            echo '{"default": true, "MD013": {"line_length": 120}}' > .markdownlint.json
          fi

          # Run markdownlint
          echo "Validating markdown files..."
          echo "$MD_FILES" | xargs markdownlint > md_results.txt 2>&1 || true

          # Check results
          if [ -s md_results.txt ]; then
            echo "⚠️ Markdown validation warnings:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat md_results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat md_results.txt
            # Don't fail on markdown issues, just warn
            echo "Note: Markdown issues are warnings only"
          else
            echo "✅ All markdown files valid" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Summary
        if: always()
        run: |
          echo "### Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| YAML | ${{ steps.yaml-lint.outcome == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Shell | ${{ steps.shell-lint.outcome == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown | ${{ steps.markdown-lint.outcome == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for secrets in diff
        run: |
          echo "### Security Scan" >> $GITHUB_STEP_SUMMARY

          # Get list of changed files
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Common secret patterns
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api[_-]?key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
            "AKIA[0-9A-Z]{16}"
            "-----BEGIN (RSA |EC |DSA )?PRIVATE KEY-----"
          )

          SECRETS_FOUND=0

          for file in $CHANGED_FILES; do
            if [ ! -f "$file" ]; then
              continue
            fi

            for pattern in "${PATTERNS[@]}"; do
              if grep -iE "$pattern" "$file" > /dev/null 2>&1; then
                echo "⚠️ Potential secret found in $file"
                SECRETS_FOUND=$((SECRETS_FOUND + 1))
              fi
            done
          done

          if [ $SECRETS_FOUND -gt 0 ]; then
            echo "❌ Found $SECRETS_FOUND potential secrets in PR" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Action required**: Review the changes and remove any secrets." >> $GITHUB_STEP_SUMMARY
            echo "Use environment variables or GitHub Secrets instead." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ No secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        run: |
          echo "Setting up test environment..."

          # Check if test script exists
          if [ -f "scripts/test-issue-flow.sh" ]; then
            chmod +x scripts/test-issue-flow.sh
          fi

          if [ -f "package.json" ]; then
            npm install
          fi

          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi

      - name: Run tests
        run: |
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY

          # Check for various test frameworks
          TESTS_RUN=false

          # npm/yarn tests
          if [ -f "package.json" ]; then
            if jq -e '.scripts.test' package.json > /dev/null 2>&1; then
              echo "Running npm tests..."
              npm test > test_results.txt 2>&1 || true
              TESTS_RUN=true
            fi
          fi

          # Python tests
          if [ -f "pytest.ini" ] || [ -d "tests" ]; then
            if command -v pytest > /dev/null 2>&1; then
              echo "Running pytest..."
              pytest --verbose > test_results.txt 2>&1 || true
              TESTS_RUN=true
            fi
          fi

          # Custom test script
          if [ -f "scripts/test-issue-flow.sh" ]; then
            echo "Running custom tests..."
            bash scripts/test-issue-flow.sh > test_results.txt 2>&1 || true
            TESTS_RUN=true
          fi

          if [ "$TESTS_RUN" = false ]; then
            echo "⚠️ No tests found to run" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Check test results
          if [ -s test_results.txt ]; then
            echo "**Test Output:**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -n 50 test_results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            if grep -qi "error\|failed\|failure" test_results.txt; then
              echo "❌ Tests failed" >> $GITHUB_STEP_SUMMARY
              cat test_results.txt
              exit 1
            else
              echo "✅ All tests passed" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  final-status:
    name: Final Status Check
    runs-on: ubuntu-latest
    needs: [validate-syntax, security-scan, run-tests]
    if: always()

    steps:
      - name: Check overall status
        uses: actions/github-script@v7
        with:
          script: |
            const jobs = [
              { name: 'validate-syntax', result: '${{ needs.validate-syntax.result }}' },
              { name: 'security-scan', result: '${{ needs.security-scan.result }}' },
              { name: 'run-tests', result: '${{ needs.run-tests.result }}' }
            ];

            const failed = jobs.filter(j => j.result === 'failure');
            const passed = jobs.filter(j => j.result === 'success');

            let summary = '## PR Validation Summary\n\n';
            summary += `✅ ${passed.length} checks passed\n`;
            summary += `❌ ${failed.length} checks failed\n\n`;

            summary += '### Details\n\n';
            jobs.forEach(job => {
              const icon = job.result === 'success' ? '✅' :
                           job.result === 'failure' ? '❌' : '⚠️';
              summary += `${icon} ${job.name}: ${job.result}\n`;
            });

            core.summary.addRaw(summary);
            await core.summary.write();

            if (failed.length > 0) {
              core.setFailed(`${failed.length} validation check(s) failed`);
            }
