name: Copilot Auto-Assign Workflow

on:
  issues:
    types: [assigned]

permissions:
  issues: write
  pull-requests: write
  contents: write

jobs:
  check-assignee:
    name: Check if Copilot was assigned
    runs-on: ubuntu-latest
    outputs:
      is-copilot: ${{ steps.check.outputs.is-copilot }}
      issue-number: ${{ github.event.issue.number }}
      issue-title: ${{ github.event.issue.title }}
    steps:
      - name: Check assignee
        id: check
        run: |
          ASSIGNEE="${{ github.event.issue.assignee.login }}"
          echo "Assignee: $ASSIGNEE"
          if [[ "$ASSIGNEE" == "copilot" ]] || [[ "$ASSIGNEE" == *"copilot"* ]]; then
            echo "is-copilot=true" >> $GITHUB_OUTPUT
          else
            echo "is-copilot=false" >> $GITHUB_OUTPUT
          fi

  process-issue:
    name: Process Issue with AI Agent
    needs: check-assignee
    if: needs.check-assignee.outputs.is-copilot == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract issue details
        id: issue-details
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // Extract structured data from issue body
            const body = issue.body || '';

            // Parse task details
            const taskTitle = body.match(/### Task Title\s*\n\s*(.+)/)?.[1] || issue.title;
            const description = body.match(/### Description\s*\n\s*([\s\S]*?)(?=###|$)/)?.[1]?.trim() || '';
            const acceptanceCriteria = body.match(/### Acceptance Criteria\s*\n\s*([\s\S]*?)(?=###|$)/)?.[1]?.trim() || '';
            const context = body.match(/### Context & Constraints\s*\n\s*([\s\S]*?)(?=###|$)/)?.[1]?.trim() || '';

            core.setOutput('task-title', taskTitle);
            core.setOutput('description', description);
            core.setOutput('acceptance-criteria', acceptanceCriteria);
            core.setOutput('context', context);
            core.setOutput('issue-number', issue.number);

            return {
              taskTitle,
              description,
              acceptanceCriteria,
              context,
              issueNumber: issue.number
            };

      - name: Create working branch
        id: create-branch
        run: |
          BRANCH_NAME="copilot/issue-${{ needs.check-assignee.outputs.issue-number }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Load knowledge base context
        id: knowledge-base
        run: |
          KB_CONTEXT=""

          # Check if knowledge base exists
          if [ -d "docs/knowledge" ]; then
            echo "Loading knowledge base context..."

            # Load relevant patterns
            if [ -d "docs/knowledge/patterns" ]; then
              KB_CONTEXT="${KB_CONTEXT}\n\n## Relevant Patterns\n"
              KB_CONTEXT="${KB_CONTEXT}$(find docs/knowledge/patterns -name '*.md' -exec cat {} \;)"
            fi

            # Load recent insights
            if [ -d "docs/knowledge/insights" ]; then
              KB_CONTEXT="${KB_CONTEXT}\n\n## Recent Insights\n"
              KB_CONTEXT="${KB_CONTEXT}$(find docs/knowledge/insights -name '*.md' -mtime -30 -exec cat {} \;)"
            fi
          fi

          echo "kb-context<<EOF" >> $GITHUB_OUTPUT
          echo -e "$KB_CONTEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate implementation (Simulated)
        run: |
          # In a real implementation, this would call an AI API
          # For this simulation, we create a placeholder commit

          echo "# Implementation for Issue #${{ needs.check-assignee.outputs.issue-number }}" > IMPLEMENTATION.md
          echo "" >> IMPLEMENTATION.md
          echo "## Task: ${{ steps.issue-details.outputs.task-title }}" >> IMPLEMENTATION.md
          echo "" >> IMPLEMENTATION.md
          echo "## Implementation Details" >> IMPLEMENTATION.md
          echo "" >> IMPLEMENTATION.md
          echo "This would be generated by the AI agent based on:" >> IMPLEMENTATION.md
          echo "- Issue description" >> IMPLEMENTATION.md
          echo "- Acceptance criteria" >> IMPLEMENTATION.md
          echo "- Knowledge base context" >> IMPLEMENTATION.md
          echo "- Repository structure" >> IMPLEMENTATION.md

          git add IMPLEMENTATION.md
          git commit -m "feat: implement issue #${{ needs.check-assignee.outputs.issue-number }}

Task: ${{ steps.issue-details.outputs.task-title }}

Implemented by @copilot AI agent

Closes #${{ needs.check-assignee.outputs.issue-number }}"

      - name: Push branch
        run: |
          git push -u origin "${{ steps.create-branch.outputs.branch-name }}"

      - name: Create pull request
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.check-assignee.outputs.issue-number }};
            const branchName = '${{ steps.create-branch.outputs.branch-name }}';

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Copilot] Implement issue #${issueNumber}`,
              head: branchName,
              base: 'main',
              body: `## ü§ñ AI-Generated Implementation

This PR was automatically created by @copilot to address issue #${issueNumber}.

### Issue Details
${{ steps.issue-details.outputs.task-title }}

### Acceptance Criteria
${{ steps.issue-details.outputs.acceptance-criteria }}

### Implementation Approach
The implementation was generated based on:
- Issue requirements
- Knowledge base patterns
- Repository context
- Best practices from 2026 AI coding standards

### Review Checklist
- [ ] Code meets acceptance criteria
- [ ] All tests pass
- [ ] Syntax validation passes
- [ ] Documentation updated
- [ ] Knowledge base updated if needed

### Next Steps
1. Review the implementation
2. Run validation checks (automatic)
3. Approve and merge if acceptable
4. Knowledge base will be automatically updated on merge

---
Closes #${issueNumber}

Generated by GitHub Actions workflow
Assigned to: @copilot
`,
              draft: false
            });

            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.data.number,
              labels: ['ai-generated', 'copilot', 'needs-review']
            });

            // Comment on original issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ü§ñ **Copilot is working on this!**

I've created PR #${pr.data.number} with an implementation.

üìã **Status**: Ready for review
üîó **Pull Request**: #${pr.data.number}
‚è±Ô∏è **Processing Time**: ~${Date.now() - context.payload.issue.updated_at} ms

The implementation will be validated automatically. Please review and merge if it meets your requirements.`
            });

            return pr.data;

  notify-failure:
    name: Notify on Failure
    needs: [check-assignee, process-issue]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.check-assignee.outputs.issue-number }},
              body: `‚ùå **Copilot encountered an error**

There was a problem processing this issue automatically.

**Error Details**: Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

**Next Steps**:
1. Review the error logs
2. Verify the issue template is complete
3. Try reassigning to @copilot
4. If the issue persists, assign to a human developer

cc: @owner`
            });
