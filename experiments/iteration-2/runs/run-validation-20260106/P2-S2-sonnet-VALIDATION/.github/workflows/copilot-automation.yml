name: Copilot Automation

on:
  issues:
    types: [assigned]

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  copilot-task:
    name: Process Copilot Task
    runs-on: ubuntu-latest

    # Only run when @copilot is assigned
    if: github.event.assignee.login == 'copilot'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add copilot label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['copilot', 'automated']
            });

      - name: Post acknowledgment comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const comment = `ðŸ¤– **@copilot acknowledges this task**

            I'll start working on this issue shortly. Here's what I'll do:

            1. ðŸ“š Load relevant knowledge from the knowledge base
            2. ðŸ”€ Create a feature branch: \`copilot/issue-${issueNumber}\`
            3. ðŸ’» Implement the requested changes
            4. âœ… Add tests and documentation
            5. ðŸ”„ Open a draft pull request for review

            You'll receive a notification when the PR is ready.

            *Workflow triggered at: ${new Date().toISOString()}*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });

      - name: Load knowledge base
        id: knowledge
        run: |
          echo "Loading knowledge base from docs/knowledge/..."

          # Create knowledge context file
          KNOWLEDGE_FILE="copilot-knowledge-context.md"

          echo "# Knowledge Base Context for Issue #${{ github.event.issue.number }}" > "$KNOWLEDGE_FILE"
          echo "" >> "$KNOWLEDGE_FILE"
          echo "## Patterns" >> "$KNOWLEDGE_FILE"

          # Load patterns
          if [ -d "docs/knowledge/patterns" ]; then
            find docs/knowledge/patterns -type f -name "*.md" | while read -r file; do
              echo "### $(basename "$file" .md)" >> "$KNOWLEDGE_FILE"
              cat "$file" >> "$KNOWLEDGE_FILE"
              echo "" >> "$KNOWLEDGE_FILE"
            done
          fi

          echo "## Decisions" >> "$KNOWLEDGE_FILE"

          # Load decisions
          if [ -d "docs/knowledge/decisions" ]; then
            find docs/knowledge/decisions -type f -name "*.md" | while read -r file; do
              echo "### $(basename "$file" .md)" >> "$KNOWLEDGE_FILE"
              cat "$file" >> "$KNOWLEDGE_FILE"
              echo "" >> "$KNOWLEDGE_FILE"
            done
          fi

          echo "## Insights" >> "$KNOWLEDGE_FILE"

          # Load insights
          if [ -d "docs/knowledge/insights" ]; then
            find docs/knowledge/insights -type f -name "*.md" | while read -r file; do
              echo "### $(basename "$file" .md)" >> "$KNOWLEDGE_FILE"
              cat "$file" >> "$KNOWLEDGE_FILE"
              echo "" >> "$KNOWLEDGE_FILE"
            done
          fi

          echo "Knowledge base loaded successfully"
          echo "knowledge_file=$KNOWLEDGE_FILE" >> "$GITHUB_OUTPUT"

      - name: Create feature branch
        run: |
          BRANCH_NAME="copilot/issue-${{ github.event.issue.number }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"

          echo "Created branch: $BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> "$GITHUB_ENV"

      - name: Invoke Copilot (Simulated)
        run: |
          echo "==================================="
          echo "COPILOT INVOCATION (SIMULATED)"
          echo "==================================="
          echo ""
          echo "In production, this step would invoke the GitHub Copilot coding agent."
          echo ""
          echo "Issue: #${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"
          echo "Branch: $BRANCH_NAME"
          echo "Knowledge: ${{ steps.knowledge.outputs.knowledge_file }}"
          echo ""
          echo "Expected behavior:"
          echo "  1. Copilot reads issue description and acceptance criteria"
          echo "  2. Copilot loads knowledge base context"
          echo "  3. Copilot implements code changes"
          echo "  4. Copilot adds tests and documentation"
          echo "  5. Copilot commits changes to branch"
          echo "  6. Copilot opens draft PR"
          echo ""
          echo "==================================="
