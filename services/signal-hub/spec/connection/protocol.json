{
  "domain": "connection",
  "description": "Connection lifecycle management - WebSocket establishment, authentication, and disconnection",
  "version": "1.0",
  "messages": {
    "hub:connect": {
      "direction": "client-to-server",
      "pattern": "request",
      "description": "Establish WebSocket connection and authenticate",
      "payload": {
        "type": "object",
        "required": ["version"],
        "properties": {
          "version": {
            "type": "string",
            "description": "Protocol version (e.g., '1.0')"
          },
          "jwt": {
            "type": "string",
            "description": "JWT authentication token (required if AUTH_ENABLED=true)"
          }
        }
      },
      "response": "hub:connected",
      "errors": ["version_mismatch", "unauthorized"]
    },
    "hub:connected": {
      "direction": "server-to-client",
      "pattern": "response",
      "description": "Connection established successfully",
      "payload": {
        "type": "object",
        "required": ["sessionId", "serverTime"],
        "properties": {
          "sessionId": {
            "type": "string",
            "description": "Unique session identifier"
          },
          "actorIdentity": {
            "$ref": "../schemas/canonical-address.schema.json#/definitions/CanonicalAddress",
            "description": "Verified actor identity from JWT"
          },
          "capabilities": {
            "type": "array",
            "items": {"type": "string"},
            "description": "Permitted actions from JWT"
          },
          "serverTime": {
            "type": "integer",
            "description": "Server timestamp (epoch ms)"
          }
        }
      }
    },
    "hub:heartbeat": {
      "direction": "client-to-server",
      "pattern": "request",
      "description": "Keep-alive message to detect dead connections",
      "payload": {
        "type": "object",
        "required": ["timestamp"],
        "properties": {
          "timestamp": {
            "type": "integer",
            "description": "Client timestamp (epoch ms)"
          }
        }
      },
      "response": "hub:heartbeat_ack",
      "notes": [
        "Client sends every 300 seconds (5 min) by default — configurable via HB_INTERVAL_SECONDS env var",
        "Cloudflare handles TCP-level connection health natively via its hibernatable WebSocket API (ping/pong at infrastructure layer)",
        "App-level heartbeat is for application-layer session state verification, NOT for keepalive",
        "ANY message (not just hub:heartbeat) updates lastHeartbeat timestamp"
      ]
    },
    "hub:heartbeat_ack": {
      "direction": "server-to-client",
      "pattern": "response",
      "description": "Heartbeat acknowledgment with server time",
      "payload": {
        "type": "object",
        "required": ["serverTime"],
        "properties": {
          "serverTime": {
            "type": "integer",
            "description": "Server timestamp (epoch ms)"
          }
        }
      }
    },
    "hub:disconnect": {
      "direction": "client-to-server",
      "pattern": "request",
      "description": "Graceful disconnection with cleanup",
      "payload": {
        "type": "object",
        "properties": {
          "reason": {
            "type": "string",
            "description": "Human-readable disconnect reason"
          }
        }
      },
      "response": "hub:disconnect_ack",
      "notes": [
        "Server MUST send ack BEFORE closing WebSocket",
        "Cleanup includes: unregister actor, remove subscriptions, delete session"
      ]
    },
    "hub:disconnect_ack": {
      "direction": "server-to-client",
      "pattern": "response",
      "description": "Disconnect acknowledged, cleanup complete",
      "payload": {
        "type": "object",
        "required": ["sessionId", "cleanedUp"],
        "properties": {
          "sessionId": {
            "type": "string",
            "description": "Session that was cleaned up"
          },
          "cleanedUp": {
            "type": "boolean",
            "description": "Whether cleanup completed successfully"
          }
        }
      }
    }
  },
  "configuration": {
    "HB_INTERVAL_SECONDS": {
      "value": 300,
      "unit": "seconds",
      "description": "App-level heartbeat interval (default 300s / 5 min). Set via HB_INTERVAL_SECONDS env var. Cloudflare handles TCP-level keepalive natively."
    },
    "HEARTBEAT_INTERVAL": {
      "value": 300000,
      "unit": "milliseconds",
      "description": "Legacy env var (ms). Superseded by HB_INTERVAL_SECONDS. Kept for backward compatibility."
    },
    "HEARTBEAT_TIMEOUT": {
      "value": 600000,
      "unit": "milliseconds",
      "description": "Server considers connection stale after 600s (2 × heartbeat interval)"
    },
    "DISCONNECT_TIMEOUT": {
      "value": 30000,
      "unit": "milliseconds",
      "description": "Max time for cleanup in disconnecting state"
    }
  }
}
