{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "name": "ConnectionLifecycle",
  "description": "WebSocket connection lifecycle state machine for Signal Hub",
  "version": "1.0",
  "initial": "connecting",
  "states": {
    "connecting": {
      "description": "WebSocket accepted, session created, awaiting hub:connect",
      "type": "state",
      "on": {
        "hub:connect_success": {
          "target": "connected",
          "guard": {
            "all": [
              "validJWT",
              "versionMatch"
            ]
          },
          "actions": [
            "storeSession",
            "setActorIdentity",
            "enableRateLimiting",
            "sendConnectedResponse"
          ]
        },
        "hub:connect_fail": {
          "target": "disconnected",
          "actions": [
            "sendErrorResponse",
            "closeWebSocket",
            "removeSession"
          ]
        },
        "websocket_close": {
          "target": "disconnected",
          "description": "Client disconnects before completing hub:connect",
          "actions": [
            "removeSession"
          ]
        }
      },
      "characteristics": {
        "authentication": "not authenticated",
        "messageTypes": ["hub:connect"],
        "rateLimiting": "disabled for hub:connect",
        "heartbeat": "not expected"
      }
    },
    "connected": {
      "description": "Fully authenticated, operational connection",
      "type": "state",
      "on": {
        "hub:disconnect": {
          "target": "disconnecting",
          "description": "Graceful disconnect initiated by client",
          "actions": [
            "unregisterActor",
            "cleanupSubscriptions",
            "sendDisconnectAck"
          ]
        },
        "websocket_close": {
          "target": "disconnected",
          "description": "Abnormal disconnect (network failure, crash)",
          "actions": [
            "emergencyCleanup"
          ]
        },
        "heartbeat_timeout": {
          "target": "disconnected",
          "description": "No heartbeat for 60 seconds",
          "guard": {
            "expression": "Date.now() - session.lastHeartbeat > 60000"
          },
          "actions": [
            "logTimeout",
            "closeWebSocket",
            "emergencyCleanup"
          ]
        }
      },
      "characteristics": {
        "authentication": "authenticated (if AUTH_ENABLED=true)",
        "messageTypes": "all types allowed",
        "rateLimiting": "100 messages/minute",
        "heartbeat": "expected every 60 seconds"
      }
    },
    "disconnecting": {
      "description": "Cleanup in progress, awaiting WebSocket close",
      "type": "state",
      "on": {
        "websocket_close": {
          "target": "disconnected",
          "description": "Normal progression after cleanup",
          "actions": [
            "transitionToDisconnected",
            "removeSession"
          ]
        },
        "cleanup_timeout": {
          "target": "disconnected",
          "description": "Cleanup took longer than 30 seconds",
          "guard": {
            "expression": "Date.now() - session.disconnectedAt > 30000"
          },
          "actions": [
            "forceCloseWebSocket",
            "removeSession"
          ]
        }
      },
      "entry": [
        "setDisconnectingState",
        "recordDisconnectTimestamp"
      ],
      "characteristics": {
        "messageProcessing": "hub:disconnect_ack sent, other messages ignored",
        "cleanup": "unregister actor, remove subscriptions"
      }
    },
    "disconnected": {
      "description": "Terminal state, session removed from memory",
      "type": "final",
      "characteristics": {
        "sessionState": "removed from memory",
        "messageProcessing": "none",
        "cleanup": "complete"
      }
    }
  },
  "guards": {
    "validJWT": {
      "description": "JWT is valid and not expired (only if AUTH_ENABLED=true)",
      "implementation": "validateJWT(msg.payload.jwt, env.JWT_SECRET)"
    },
    "versionMatch": {
      "description": "Protocol version matches server version",
      "implementation": "msg.payload.version === env.PROTOCOL_VERSION"
    }
  },
  "actions": {
    "storeSession": "Store session in sessions Map with WebSocket key",
    "setActorIdentity": "Set session.actorIdentity from JWT payload",
    "enableRateLimiting": "Initialize token bucket for rate limiting",
    "sendConnectedResponse": "Send hub:connected message with session details",
    "sendErrorResponse": "Send hub:error message with error code and details",
    "closeWebSocket": "Close WebSocket with code 1000",
    "removeSession": "Delete session from sessions and connections maps",
    "unregisterActor": "Remove actor from registry if registered",
    "cleanupSubscriptions": "Remove all topic subscriptions for this actor",
    "sendDisconnectAck": "Send hub:disconnect_ack before closing socket",
    "emergencyCleanup": "Cleanup without acknowledgment (abnormal close)",
    "logTimeout": "Log heartbeat timeout event",
    "transitionToDisconnected": "Set connectionState to 'disconnected'",
    "forceCloseWebSocket": "Force close WebSocket if cleanup timeout",
    "setDisconnectingState": "Set connectionState to 'disconnecting'",
    "recordDisconnectTimestamp": "Set session.disconnectedAt to Date.now()"
  },
  "metadata": {
    "format": "XState-compatible JSON",
    "compatibleWith": ["XState v4", "XState v5"],
    "source": "STATE_MACHINE.spec.md",
    "domain": "connection"
  }
}
