{
  "name": "ConnectionLifecycle",
  "description": "Connection state machine tracking WebSocket lifecycle from connect to disconnect",
  "version": "1.0",
  "initial": "connecting",
  "states": {
    "connecting": {
      "description": "WebSocket accepted, awaiting hub:connect handshake",
      "characteristics": [
        "No authentication yet",
        "Cannot send messages except hub:connect",
        "Rate limiting disabled for hub:connect",
        "Session created in memory"
      ],
      "on": {
        "hub:connect_success": {
          "target": "connected",
          "guard": "validJWT && versionMatch",
          "actions": [
            "storeSession",
            "setActorIdentity",
            "enableAuthentication",
            "sendConnected"
          ]
        },
        "hub:connect_fail": {
          "target": "disconnected",
          "guard": "invalidJWT || versionMismatch",
          "actions": [
            "sendError",
            "closeWebSocket",
            "cleanupSession"
          ]
        },
        "websocket_close": {
          "target": "disconnected",
          "description": "Client disconnected before completing handshake",
          "actions": [
            "cleanupSession"
          ]
        }
      }
    },
    "connected": {
      "description": "Fully authenticated and operational",
      "characteristics": [
        "Fully authenticated (if AUTH_ENABLED=true)",
        "Can send/receive all message types",
        "Rate limiting active (100 msg/min)",
        "Heartbeat expected every 60 seconds"
      ],
      "on": {
        "hub:disconnect": {
          "target": "disconnecting",
          "actions": [
            "unregisterActor",
            "cleanupSubscriptions",
            "sendDisconnectAck"
          ]
        },
        "websocket_close": {
          "target": "disconnected",
          "description": "Abnormal disconnect without graceful shutdown",
          "actions": [
            "emergencyCleanup"
          ]
        },
        "heartbeat_timeout": {
          "target": "disconnected",
          "guard": "noHeartbeatFor60s",
          "actions": [
            "closeWebSocket",
            "cleanupSession"
          ]
        }
      }
    },
    "disconnecting": {
      "description": "Graceful shutdown in progress",
      "characteristics": [
        "Session cleanup in progress",
        "hub:disconnect_ack sent",
        "Registry cleanup (unregister actor)",
        "Topic cleanup (remove subscriptions)"
      ],
      "on": {
        "websocket_close": {
          "target": "disconnected",
          "description": "Cleanup complete, connection closed",
          "actions": [
            "removeSession"
          ]
        },
        "cleanup_timeout": {
          "target": "disconnected",
          "guard": "cleanupTookTooLong",
          "description": "Force close after 30s timeout",
          "actions": [
            "forceCloseWebSocket",
            "removeSession"
          ]
        }
      }
    },
    "disconnected": {
      "type": "final",
      "description": "Terminal state - connection completely closed",
      "characteristics": [
        "Session removed from memory",
        "No further message processing",
        "Cleanup complete"
      ]
    }
  },
  "guards": {
    "validJWT": "JWT signature valid and not expired",
    "versionMatch": "Protocol version matches server version",
    "invalidJWT": "JWT missing, malformed, or expired",
    "versionMismatch": "Client protocol version != server version",
    "noHeartbeatFor60s": "Current time - lastHeartbeat > 60000ms",
    "cleanupTookTooLong": "Time in disconnecting state > 30000ms"
  },
  "actions": {
    "storeSession": "Create and store session in sessions Map",
    "setActorIdentity": "Set session.actorIdentity from JWT",
    "enableAuthentication": "Set session.authenticated = true",
    "sendConnected": "Send hub:connected response to client",
    "sendError": "Send hub:error with appropriate error code",
    "closeWebSocket": "Close WebSocket with code 1000 (Normal)",
    "cleanupSession": "Remove session from all maps, cleanup subscriptions",
    "unregisterActor": "Remove actor from registry",
    "cleanupSubscriptions": "Remove actor from all topic subscriptions",
    "sendDisconnectAck": "Send hub:disconnect_ack BEFORE closing WebSocket",
    "emergencyCleanup": "Cleanup without sending ack (connection already closed)",
    "removeSession": "Delete session from sessions and connections maps",
    "forceCloseWebSocket": "Force close WebSocket after timeout"
  },
  "metadata": {
    "format": "XState-compatible",
    "source": "STATE_MACHINE.spec.md",
    "compatible_with": ["XState", "Robot", "state-machine libraries"]
  }
}
