// Task Entity for Work Specification
//
// Tasks are work units with success criteria and lifecycle management.
// State machine: pending -> assigned -> in-progress -> completed | failed

package convergence:domain@0.1.0;

use address.{address};
use entity.{entity};
use signal-hub:core/types@0.1.0.{json-value};

/// Task lifecycle states
enum task-lifecycle {
    pending,
    assigned,
    in-progress,
    completed,
    failed,
}

/// Task priority levels
enum task-priority {
    p0,
    p1,
    p2,
    p3,
    p4,
}

/// Success criterion specification
record success-criterion {
    /// Criterion type (file-exists, word-count, custom, etc.)
    criterion-type: string,
    /// Criterion parameters as JSON
    params: json-value,
}

/// Task specification (inputs, outputs, constraints)
record task-spec {
    inputs: list<string>,
    outputs: list<string>,
    constraints: list<string>,
    success-criteria: list<success-criterion>,
}

/// Task configuration
record task-config {
    title: string,
    description: option<string>,
    spec: option<task-spec>,
    assignee: option<address>,
    priority: option<task-priority>,
}

/// Task resource - work specification
resource task {
    use entity.{entity};

    /// Get underlying entity
    as-entity: func() -> entity;

    /// Get task lifecycle state
    get-lifecycle: func() -> task-lifecycle;

    /// Get task configuration
    get-config: func() -> task-config;

    /// Get task result (if completed)
    get-result: func() -> option<json-value>;

    /// Get failure reason (if failed)
    get-failure-reason: func() -> option<string>;

    /// Evaluate success criteria
    evaluate-criteria: func() -> result<bool, string>;
}

/// Task lifecycle management interface
interface task-ops {
    use address.{address};

    /// Create a new task in pending state
    create-task: func(
        id: string,
        title: string,
        config: task-config
    ) -> result<address, string>;

    /// Get task by address
    get-task: func(addr: address) -> result<task, string>;

    /// Update task (only in pending/assigned)
    update-task: func(
        addr: address,
        config: task-config
    ) -> result<_, string>;

    /// Assign task to actor (pending/assigned -> assigned)
    assign-task: func(addr: address, assignee: address) -> result<_, string>;

    /// Unassign task (assigned/in-progress -> pending)
    unassign-task: func(addr: address) -> result<_, string>;

    /// Start task (assigned -> in-progress)
    start-task: func(addr: address) -> result<_, string>;

    /// Complete task (in-progress -> completed)
    complete-task: func(addr: address, result: option<json-value>) -> result<_, string>;

    /// Fail task (in-progress -> failed)
    fail-task: func(addr: address, reason: string) -> result<_, string>;

    /// List tasks by lifecycle
    list-by-lifecycle: func(lifecycle: task-lifecycle) -> list<address>;

    /// List tasks by assignee
    list-by-assignee: func(assignee: address) -> list<address>;

    /// List tasks by priority
    list-by-priority: func(priority: task-priority) -> list<address>;
}
